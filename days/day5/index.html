import React, { useState, useEffect } from "react";

const Day5Modal = ({ onClose, onComplete }) => {
  const [r1, setR1] = useState("");
  const [r1Status, setR1Status] = useState("unanswered");

  const [r2, setR2] = useState("");
  const [r2Status, setR2Status] = useState("unanswered");

  const [finished, setFinished] = useState(false);

  const normalize = (s) =>
    s.toLowerCase().replace(/[^a-z0-9-]/g, "").trim();

  // Check completion
  useEffect(() => {
    if (r1Status === "correct" && r2Status === "correct" && !finished) {
      setFinished(true);
      onComplete?.(); // send signal to parent if needed
    }
  }, [r1Status, r2Status]);

  const handleR1 = (e) => {
    e.preventDefault();
    const ans = normalize(r1);
    if (ans === "honey") setR1Status("correct");
    else setR1Status("incorrect");
  };

  const handleR2 = (e) => {
    e.preventDefault();

    // Accept "-1", "x=-1", "x = -1", etc
    const raw = r2.trim().toLowerCase();
    let val = Number(raw);
    if (isNaN(val)) {
      const match = raw.match(/-?\d+(\.\d+)?/);
      if (match) val = Number(match[0]);
    }

    if (val === -1) setR2Status("correct");
    else setR2Status("incorrect");
  };

  const reset = () => {
    setR1(""); setR2("");
    setR1Status("unanswered");
    setR2Status("unanswered");
    setFinished(false);
  };

  const badge = (status) => {
    if (status === "correct")
      return (
        <span className="ml-2 rounded bg-green-600/40 px-2 py-0.5 text-xs text-green-200">
          ✔ correct
        </span>
      );
    if (status === "incorrect")
      return (
        <span className="ml-2 rounded bg-red-600/40 px-2 py-0.5 text-xs text-red-200">
          ✖ try again
        </span>
      );
    return null;
  };

  return (
    <div className="fixed inset-0 z-40 flex items-start justify-center bg-black/60 pt-10">
      <div className="w-full max-w-3xl rounded-xl bg-slate-900/95 p-6 shadow-xl border border-slate-700">
        {/* Header */}
        <div className="flex items-center justify-between mb-5">
          <h1 className="text-xl font-semibold text-slate-100">Day 5 — Riddles</h1>
          <button
            onClick={onClose}
            className="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded"
          >
            Close
          </button>
        </div>

        {/* Intro */}
        <p className="text-slate-300 mb-6 text-sm">
          Solve both problems to reveal the first digit of the combination lock.
        </p>

        {/* PROBLEM 1 */}
        <div className="mb-5 bg-slate-800/80 p-4 rounded-lg border border-slate-700">
          <h2 className="text-sm font-semibold text-slate-100 mb-2 flex items-center">
            Problem 1 — Riddle
            {badge(r1Status)}
          </h2>

          <p className="text-slate-200 text-sm mb-3 leading-relaxed">
            “By vicious beast I'm guarded,<br />
            By death on silver wings.<br />
            Like gold, I last eternal,<br />
            Treasure to queens and kings.”
          </p>

          <form onSubmit={handleR1} className="flex gap-2">
            <input
              type="text"
              value={r1}
              onChange={(e) => setR1(e.target.value)}
              placeholder="answer"
              className="w-40 px-3 py-1 bg-slate-900 border border-slate-600 rounded text-slate-100 text-sm"
            />
            <button
              type="submit"
              className="px-3 py-1 bg-amber-400 hover:bg-amber-300 text-slate-900 rounded text-sm"
            >
              Submit
            </button>
          </form>
        </div>

        {/* PROBLEM 2 */}
        <div className="mb-5 bg-slate-800/80 p-4 rounded-lg border border-slate-700">
          <h2 className="text-sm font-semibold text-slate-100 mb-2 flex items-center">
            Problem 2 — Solve for x
            {badge(r2Status)}
          </h2>

          <p className="text-slate-200 text-sm mb-3 font-mono">
            7·3^x + 3^x + 3^x = 9·3^x · 27 · 3^x · 9^x
          </p>

          <form onSubmit={handleR2} className="flex gap-2">
            <input
              type="text"
              value={r2}
              onChange={(e) => setR2(e.target.value)}
              placeholder="x = ?"
              className="w-32 px-3 py-1 bg-slate-900 border border-slate-600 rounded text-slate-100 text-sm"
            />
            <button
              type="submit"
              className="px-3 py-1 bg-amber-400 hover:bg-amber-300 text-slate-900 rounded text-sm"
            >
              Submit
            </button>
          </form>
        </div>

        {/* FOOTER */}
        <div className="flex items-center justify-between">
          <button
            onClick={reset}
            className="px-3 py-1 border border-slate-600 text-slate-300 text-xs rounded hover:bg-slate-700"
          >
            Reset Day 5
          </button>

          {finished && (
            <div className="px-3 py-2 rounded bg-green-600/20 text-green-200 text-xs">
              Great job! The first digit of the combination lock is{" "}
              <span className="font-bold text-green-100">5</span>.
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default Day5Modal;
