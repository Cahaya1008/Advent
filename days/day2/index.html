<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Day 2 ‚Äì Maze Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --maze-wall: #020617;
      --maze-floor: #030712;
      --maze-trap: #4b5563;
      --maze-traproom: #111827;
      --maze-fog: #4c1d95;
      --maze-speed: #16a34a;
      --player: #f97373; /* runner is red, so we don‚Äôt use red as a tile */
      --goal: #facc15;
      --text-main: #f9fafb;
      --muted: #9ca3af;
      --good: #22c55e;
      --accent: #f97373;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1.5rem 0.75rem;
      color: var(--text-main);
    }

    .page {
      max-width: 980px;
      width: 100%;
      background: linear-gradient(135deg, #020617, #020617 40%, #020617 100%);
      border-radius: 22px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
      padding: 1.7rem 1.6rem 1.3rem;
      position: relative;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .header-left {
      flex: 1;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      background: rgba(248, 250, 252, 0.06);
      padding: 0.24rem 0.6rem;
      border-radius: 999px;
      margin-bottom: 0.35rem;
      border: 1px solid rgba(248, 250, 252, 0.15);
    }

    h1 {
      font-size: 1.9rem;
      margin-bottom: 0.15rem;
    }

    header p {
      font-size: 0.9rem;
      color: var(--muted);
      max-width: 540px;
    }

    .already-banner {
      position: absolute;
      top: 0.7rem;
      right: 0.9rem;
      font-size: 0.75rem;
      background: rgba(22, 163, 74, 0.12);
      border-radius: 999px;
      padding: 0.18rem 0.6rem;
      border: 1px solid rgba(74, 222, 128, 0.7);
      color: #bbf7d0;
      display: none;
    }

    main {
      margin-top: 0.3rem;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(230px, 1fr);
      gap: 1rem;
    }

    .maze-panel {
      background: radial-gradient(circle at top, #020617, #020617 70%, #000 100%);
      border-radius: 18px;
      padding: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      min-height: 520px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .maze-container {
      position: relative;
      padding: 0.6rem;
      border-radius: 18px;
      background: #020617;
      box-shadow:
        0 0 0 2px rgba(148, 163, 184, 0.7),
        0 0 40px rgba(15, 23, 42, 1);
    }

    .maze-grid {
      display: grid;
      gap: 0;
    }

    .maze-grid.fog-mode .cell {
      opacity: 0.12;
      transition: opacity 0.15s ease;
    }

    .maze-grid.fog-mode .cell.visible {
      opacity: 1;
    }

    .cell {
      width: 22px;
      height: 22px;
      position: relative;
    }

    .cell.wall {
      background: var(--maze-wall);
    }

    .cell.floor {
      background: var(--maze-floor);
    }

    .cell.trap {
      background: var(--maze-trap);
      box-shadow: inset 0 0 0 2px rgba(31, 41, 55, 0.9);
    }

    .cell.traproom {
      background: var(--maze-traproom);
    }

    .cell.fog {
      background: var(--maze-fog);
      box-shadow: inset 0 0 0 2px rgba(76, 29, 149, 0.9);
    }

    .cell.fog::after {
      content: "‚òÅÔ∏é";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #e9d5ff;
    }

    .cell.speed {
      background: radial-gradient(circle at 20% 20%, #bbf7d0, #16a34a 40%, #052e16);
    }

    .cell.speed::after {
      content: "‚ö°";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #ecfdf5;
    }

    .cell.goal {
      background: radial-gradient(circle at 30% 20%, #fef3c7, #f59e0b 40%, #854d0e);
    }

    .cell.goal::after {
      content: "üéÅ";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .cell.start::after {
      content: "‚û§";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      font-size: 13px;
      padding-left: 2px;
      padding-bottom: 1px;
      color: rgba(148, 163, 184, 0.9);
    }

    .player {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--player);
      box-shadow:
        0 0 0 2px #fecaca,
        0 0 18px rgba(248, 113, 113, 0.95);
      transition: transform 0.08s linear;
      pointer-events: none;
    }

    .player.boost {
      box-shadow:
        0 0 0 2px #bbf7d0,
        0 0 22px rgba(34, 197, 94, 0.9);
    }

    .info-panel {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      padding: 0.85rem 0.9rem 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.86rem;
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
    }

    .info-panel h2 {
      font-size: 1rem;
    }

    .info-panel p {
      color: var(--muted);
      line-height: 1.5;
    }

    .legend {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem 0.75rem;
      font-size: 0.82rem;
      margin-top: 0.2rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .legend-swatch.floor { background: var(--maze-floor); }
    .legend-swatch.wall { background: var(--maze-wall); }
    .legend-swatch.trap { background: var(--maze-trap); }
    .legend-swatch.goal {
      background: radial-gradient(circle at 30% 20%, #fef3c7, #f59e0b 40%, #854d0e);
    }
    .legend-swatch.fog { background: var(--maze-fog); }
    .legend-swatch.speed {
      background: radial-gradient(circle at 20% 20%, #bbf7d0, #16a34a 40%, #052e16);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.42rem 0.9rem;
      font-size: 0.83rem;
      font-weight: 500;
      cursor: pointer;
      background: #f1f5f9;
      color: #020617;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: background 0.12s ease, transform 0.08s ease,
        box-shadow 0.12s ease;
    }

    .btn:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.35);
    }

    .btn-primary {
      background: var(--accent);
      color: #111827;
      border-color: #fecaca;
    }

    .btn-primary:hover {
      background: #fb7185;
    }

    .btn[disabled] {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .status {
      min-height: 1.2rem;
      font-size: 0.82rem;
      color: var(--muted);
      margin-top: 0.1rem;
    }

    .status-good {
      color: var(--good);
    }

    footer {
      margin-top: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
      font-size: 0.78rem;
      color: var(--muted);
    }

    /* Modal */

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 40;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      max-width: 420px;
      width: 100%;
      padding: 1.2rem 1.3rem 1.05rem;
      background: #0b1220;
      border-radius: 18px;
      color: #e5e7eb;
      position: relative;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .modal h2 {
      font-size: 1.1rem;
      margin-bottom: 0.35rem;
    }

    .modal p {
      font-size: 0.9rem;
      line-height: 1.5;
      color: #cbd5f5;
    }

    .modal-close {
      position: absolute;
      right: 0.7rem;
      top: 0.6rem;
      border: none;
      background: transparent;
      font-size: 1.2rem;
      cursor: pointer;
      color: #9ca3af;
    }

    .modal-footer {
      margin-top: 0.9rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="already-banner" id="alreadyBanner">
      Letter already collected ‚úÖ
    </div>

    <header>
      <div class="header-left">
        <div class="badge">
          <span>Day 2</span>
          <span>Maze runner</span>
        </div>
        <h1>Run the maze</h1>
        <p>
          Use the arrow keys to guide your little runner from the start corner to
          the present in the opposite corner. Some tiles are just floor. Gray tiles,
          purple fog tiles, and green power-ups all have Opinions‚Ñ¢.
        </p>
      </div>
    </header>

    <main>
      <section class="maze-panel">
        <div class="maze-container">
          <div class="maze-grid" id="mazeGrid"></div>
          <div class="player" id="player"></div>
        </div>
      </section>

      <section class="info-panel">
        <h2>How it works</h2>
        <p>
          Move with the <strong>arrow keys</strong>. You can only walk on the dark
          floor tiles, not the solid walls. Reach the glowing present to open it and
          reveal today‚Äôs letter.
        </p>

        <div class="legend">
          <div class="legend-item">
            <span class="legend-swatch floor"></span>
            <span>Walkable path</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch wall"></span>
            <span>Wall (nope)</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch trap"></span>
            <span>Gray tile ‚Äì trap teleporter</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch goal"></span>
            <span>Present ‚Äì the exit</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch fog"></span>
            <span>Purple ‚Äì fog of war</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch speed"></span>
            <span>Green circle ‚Äì speed boost</span>
          </div>
        </div>

        <p>
          Stepping on a <strong>gray tile</strong> whisks you away into a sealed trap
          room. There‚Äôs no way out of those rooms, so you‚Äôll need to restart. Purple
          fog tiles shrink your vision for a handful of moves, and green tiles give
          you a temporary speed boost.
        </p>

        <div class="btn-row">
          <button class="btn" id="restartBtn">‚Üª Restart from start</button>
          <button class="btn btn-primary" id="backBtn">‚Üê Back to calendar</button>
        </div>

        <div class="status" id="statusLine">
          Tip: fog plus speed can be a blessing or a disaster, depending how well
          you remember the route.
        </div>
      </section>
    </main>

    <footer>
      <span>Arrow keys only ‚Äì no mouse cheating.</span>
      <span>Each day hides at most one letter.</span>
    </footer>
  </div>

  <!-- Letter modal -->
  <div class="modal" id="letterModal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" data-close="letterModal">&times;</button>
      <h2>Present unlocked üéÅ</h2>
      <p>
        Inside the maze‚Äôs present you find the letter
        <strong>P</strong>. It‚Äôs been added to your letter collection on the main
        calendar page.
      </p>
      <div class="modal-footer">
        <button class="btn" data-close="letterModal">Stay in the maze</button>
        <button class="btn btn-primary" id="goHomeFromModal">Back to calendar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const DAY_LETTER_KEY = "advent_day_2_letter";
    const HIDDEN_LETTER = "P";

    // Maze legend:
    // # = wall
    // . = floor
    // S = start
    // G = goal
    // T = gray trap teleporter
    // X = trap room floor
    // F = purple fog tile
    // U = green speed boost
    //
    // NOTE: some rows are shorter; missing cells are treated as walls.
    const MAZE_ROWS = [
      "#####################",
      "#S....#....######...#",
      "#####.#.##.#....#.###",
      "#..F..#.#..#.##.#..G#",
      "#.###.#.#.##.#.####.#",
      "#.#...#.#.U.#....#.#",
      "#.#.###.######.##.#.#",
      "#.#.....#....#.#..#.#",
      "#.#####.#.##.#.##.#.#",
      "#.....#.#.#..#.#..#.#",
      "###.#.#.#.##.#.#.##.#",
      "#...#.#.#....#.#....#",
      "#.###.#.######.####.#",
      "#.#...#......#..F.#.#",
      "#.#.######.####.#.#.#",
      "#.#......#......#.#.#",
      "#.####.#.########.#.#",
      "#....#.#......T..#.#.#",
      "####.#.###########.#X",
      "#....#....U.......#X#",
      "#####################"
    ];

    const mazeGridEl = document.getElementById("mazeGrid");
    const playerEl = document.getElementById("player");
    const statusLineEl = document.getElementById("statusLine");
    const alreadyBanner = document.getElementById("alreadyBanner");

    let rows = MAZE_ROWS.length;
    let cols = MAZE_ROWS[0].length;

    let grid = [];
    let startPos = { row: 0, col: 0 };
    let goalPos = { row: 0, col: 0 };
    let trapRoomStart = null;

    let playerPos = { row: 0, col: 0 };
    let inTrapRoom = false;
    let hasWon = false;

    // Fog + speed state
    let fogMovesRemaining = 0;
    let speedBoostUntil = 0;

    function setStatus(message, tone = "") {
      statusLineEl.textContent = message;
      if (tone === "good") {
        statusLineEl.className = "status status-good";
      } else {
        statusLineEl.className = "status";
      }
    }

    function openModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
    }

    function buildGrid() {
      grid = [];
      mazeGridEl.innerHTML = "";

      rows = MAZE_ROWS.length;
      cols = MAZE_ROWS[0].length;
      mazeGridEl.style.gridTemplateColumns = `repeat(${cols}, 22px)`;

      MAZE_ROWS.forEach((rowStr, r) => {
        const rowArr = [];
        for (let c = 0; c < cols; c++) {
          const ch = rowStr[c] || "#"; // treat missing as wall
          let type = "wall";
          if (ch === ".") type = "floor";
          else if (ch === "#") type = "wall";
          else if (ch === "S") type = "start";
          else if (ch === "G") type = "goal";
          else if (ch === "T") type = "trap";
          else if (ch === "X") type = "traproom";
          else if (ch === "F") type = "fog";
          else if (ch === "U") type = "speed";

          const cellEl = document.createElement("div");
          cellEl.classList.add("cell");
          cellEl.dataset.row = r;
          cellEl.dataset.col = c;

          if (type === "wall") cellEl.classList.add("wall");
          if (type === "floor") cellEl.classList.add("floor");
          if (type === "start") {
            cellEl.classList.add("floor", "start");
            startPos = { row: r, col: c };
          }
          if (type === "goal") {
            cellEl.classList.add("floor", "goal");
            goalPos = { row: r, col: c };
          }
          if (type === "trap") {
            cellEl.classList.add("trap");
          }
          if (type === "traproom") {
            cellEl.classList.add("traproom");
            if (!trapRoomStart) {
              trapRoomStart = { row: r, col: c };
            }
          }
          if (type === "fog") {
            cellEl.classList.add("floor", "fog");
          }
          if (type === "speed") {
            cellEl.classList.add("floor", "speed");
          }

          mazeGridEl.appendChild(cellEl);
          rowArr.push(type);
        }
        grid.push(rowArr);
      });
    }

    function cellType(row, col) {
      if (row < 0 || row >= rows || col < 0 || col >= cols) return "wall";
      return grid[row][col] || "wall";
    }

    function updatePlayerPosition(animated = true) {
      const cellSize = 22;
      const offset = (cellSize - 18) / 2;

      const x = playerPos.col * cellSize + offset;
      const y = playerPos.row * cellSize + offset;

      if (!animated) {
        playerEl.style.transition = "none";
      } else {
        playerEl.style.transition = "transform 0.08s linear";
      }

      playerEl.style.transform = `translate(${x}px, ${y}px)`;

      if (fogMovesRemaining > 0) {
        updateFogVisibility();
      }
    }

    function restartMaze() {
      playerPos = { ...startPos };
      inTrapRoom = false;
      hasWon = false;
      fogMovesRemaining = 0;
      speedBoostUntil = 0;
      mazeGridEl.classList.remove("fog-mode");
      clearFogHighlights();
      playerEl.classList.remove("boost");
      updatePlayerPosition(false);
      setStatus(
        "Back at the entrance. See if you can remember where the traps and fog were.",
        ""
      );
    }

    function activateFog() {
      fogMovesRemaining = 10; // ~10 moves
      mazeGridEl.classList.add("fog-mode");
      updateFogVisibility();
      setStatus("A purple mist rolls in‚Ä¶ your vision shrinks for a few moves.", "");
    }

    function clearFog() {
      fogMovesRemaining = 0;
      mazeGridEl.classList.remove("fog-mode");
      clearFogHighlights();
      setStatus("", "");
    }

    function clearFogHighlights() {
      const cells = mazeGridEl.querySelectorAll(".cell");
      cells.forEach((cell) => cell.classList.remove("visible"));
    }

    function updateFogVisibility() {
      if (fogMovesRemaining <= 0) {
        clearFog();
        return;
      }
      const cells = mazeGridEl.querySelectorAll(".cell");
      cells.forEach((cell) => {
        const r = Number(cell.dataset.row);
        const c = Number(cell.dataset.col);
        const dist =
          Math.abs(r - playerPos.row) + Math.abs(c - playerPos.col);
        if (dist <= 2) {
          cell.classList.add("visible");
        } else {
          cell.classList.remove("visible");
        }
      });
      mazeGridEl.classList.add("fog-mode");
    }

    function activateSpeed() {
      const now = performance.now();
      speedBoostUntil = now + 5000; // 5 seconds
      playerEl.classList.add("boost");
      setStatus("Speed boost! Each arrow moves you twice as far for a few seconds.", "good");
    }

    function handleTileType(type) {
      if (type === "trap") {
        if (trapRoomStart) {
          playerPos = { ...trapRoomStart };
          inTrapRoom = true;
          updatePlayerPosition(true);
          setStatus(
            "Uh oh. You fell into a sealed trap room. Only the restart button can save you now.",
            ""
          );
        }
        return true; // handled
      }

      if (type === "goal") {
        handleWin();
        return true;
      }

      if (type === "fog") {
        activateFog();
      } else if (type === "speed") {
        activateSpeed();
      } else if (inTrapRoom) {
        setStatus("This room has no exits. You‚Äôll need to restart.", "");
      } else {
        // normal floor-ish move
        if (fogMovesRemaining <= 0) {
          setStatus("", "");
        }
      }
      return false;
    }

    function movePlayer(dx, dy) {
      if (hasWon) return;

      const now = performance.now();
      const boosted = speedBoostUntil > now;
      if (!boosted) {
        playerEl.classList.remove("boost");
      }

      const steps = boosted ? 2 : 1;

      for (let step = 0; step < steps; step++) {
        const newRow = playerPos.row + dy;
        const newCol = playerPos.col + dx;

        const type = cellType(newRow, newCol);
        if (type === "wall") break;

        // move
        playerPos = { row: newRow, col: newCol };
        updatePlayerPosition(true);

        const stop = handleTileType(type);
        if (stop) break;
      }

      // decrement fog duration per keypress
      if (fogMovesRemaining > 0) {
        fogMovesRemaining--;
        if (fogMovesRemaining <= 0) {
          clearFog();
        } else {
          updateFogVisibility();
        }
      }
    }

    function handleWin() {
      hasWon = true;
      setStatus("You found the present! It creaks open‚Ä¶", "good");

      if (!localStorage.getItem(DAY_LETTER_KEY)) {
        localStorage.setItem(DAY_LETTER_KEY, HIDDEN_LETTER);
      }
      alreadyBanner.style.display = "block";
      setTimeout(() => {
        openModal("letterModal");
      }, 250);
    }

    function init() {
      if (localStorage.getItem(DAY_LETTER_KEY)) {
        alreadyBanner.style.display = "block";
      }

      buildGrid();
      playerPos = { ...startPos };
      updatePlayerPosition(false);

      document.addEventListener("keydown", (e) => {
        const key = e.key;
        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(key)) {
          e.preventDefault();
        }

        if (key === "ArrowUp") movePlayer(0, -1);
        if (key === "ArrowDown") movePlayer(0, 1);
        if (key === "ArrowLeft") movePlayer(-1, 0);
        if (key === "ArrowRight") movePlayer(1, 0);
      });

      document.getElementById("restartBtn").addEventListener("click", () => {
        restartMaze();
      });

      document.getElementById("backBtn").addEventListener("click", () => {
        window.location.href = "../../index.html";
      });

      document
        .querySelectorAll("[data-close]")
        .forEach((btn) =>
          btn.addEventListener("click", () =>
            closeModal(btn.getAttribute("data-close"))
          )
        );

      document.getElementById("goHomeFromModal").addEventListener("click", () => {
        window.location.href = "../../index.html";
      });

      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.classList.remove("open");
            modal.setAttribute("aria-hidden", "true");
          }
        });
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal.open")
            .forEach((m) => m.classList.remove("open"));
        }
      });
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
