<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Day 2 – Bracket City</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --panel-bg: #faf5ef;
      --highlight: #dfe7ff;
      --highlight-inner: #adc2ff;
      --correct: #16a34a;
      --error: #b91c1c;
      --text-muted: #6b7280;
      --accent: #7b2333;
      --accent-light: #f4e4d8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Poppins", sans-serif;
      background: radial-gradient(circle at top, #1a2333, #040611 70%);
      min-height: 100vh;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .page {
      background: var(--panel-bg);
      width: 100%;
      max-width: 720px;
      padding: 1.6rem;
      border-radius: 20px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.45);
      position: relative;
    }

    header { text-align: center; margin-bottom: 1rem; }

    header h1 {
      color: var(--accent);
      font-size: 1.8rem;
      margin-bottom: 0.3rem;
    }

    header p {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .already-banner {
      position: absolute;
      right: 1rem;
      top: 1rem;
      font-size: 0.8rem;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      background: #ecfdf5;
      border: 1px solid #c6f2df;
      color: #065f46;
      display: none;
    }

    /* bracket area */
    #puzzleSentence {
      line-height: 1.6;
      font-size: 1.05rem;
      background: #fff;
      padding: 1rem;
      border-radius: 14px;
      border: 1px solid #e4dfd9;
      margin-bottom: 1rem;
      min-height: 60px;
    }

    .bracket {
      background: var(--highlight);
      border-radius: 6px;
      padding: 0 4px;
      cursor: pointer;
      transition: background 0.15s;
      border: 1px dashed #90aaff;
    }

    .bracket.innermost {
      background: var(--highlight-inner);
    }

    /* controls */
    #currentClue {
      margin-top: 0.3rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    #answerInput {
      width: 100%;
      padding: 0.7rem 1rem;
      border-radius: 12px;
      border: 1px solid #d4c8bc;
      margin-top: 0.7rem;
      font-size: 1rem;
    }

    #submitAnswer {
      margin-top: 0.6rem;
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.65rem 1.1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    #submitAnswer:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      transform: translateY(-1px);
    }

    #status {
      margin-top: 0.5rem;
      min-height: 1.2rem;
      font-size: 0.85rem;
    }

    #status.error { color: var(--error); }
    #status.success { color: var(--correct); }

    #stepProgress {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* hint */
    #hintContainer {
      display: none;
      margin-top: 1rem;
      background: #fef3c7;
      padding: 0.9rem;
      border-radius: 12px;
      border: 1px dashed #fcd34d;
      font-size: 0.88rem;
    }

    /* final clickable letters */
    .letter {
      display: inline-block;
      padding: 2px 3px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.1s;
    }

    .letter:hover {
      background: #fee2e2;
    }

    /* modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 20;
    }

    .modal.open { display: flex; }

    .modal-content {
      background: #fff8f0;
      padding: 1.3rem;
      border-radius: 18px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      position: relative;
    }

    .modal-close {
      position: absolute;
      right: 0.7rem;
      top: 0.7rem;
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: #555;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-secondary {
      background: var(--accent-light);
      color: #5a4032;
      border: 1px solid #d6c0b4;
    }

    footer {
      margin-top: 1.3rem;
      text-align: center;
    }

    footer button {
      margin-top: 0.4rem;
    }
  </style>
</head>
<body>
  <div class="page">

    <div class="already-banner" id="alreadyBanner">Letter already collected</div>

    <header>
      <h1>Day 2 – Bracket City</h1>
      <p>Solve *any* innermost bracket. When all brackets disappear, the hidden letter will reveal itself.</p>
    </header>

    <div id="puzzleSentence"></div>
    <div id="currentClue"></div>

    <input id="answerInput" placeholder="Type answer for selected bracket…" />
    <button id="submitAnswer">Submit</button>

    <div id="status"></div>
    <div id="stepProgress"></div>

    <div id="hintContainer">
      <strong>Hint for hidden letter:</strong>
      In the final sentence, find the word describing size. Click its first letter.
    </div>

    <footer>
      <button class="btn-secondary" id="backBtn">← Back to calendar</button>
    </footer>
  </div>

  <!-- modal -->
  <div class="modal" id="letterModal">
    <div class="modal-content">
      <button class="modal-close" data-close="letterModal">&times;</button>
      <h3>Letter collected!</h3>
      <p>Your letter has been added to the main calendar.</p>
      <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
        <button class="btn-secondary" data-close="letterModal">Stay</button>
        <button class="btn" id="goHome">Back to calendar</button>
      </div>
    </div>
  </div>

  <script>
    const DAY_KEY = "advent_day_2_letter";
    const FINAL_SENTENCE = "COZY LITTLE CITY YOU AND ME";
    const HIDDEN_LETTER = "L";

    /* The bracket city puzzle structure */
    let puzzleText = 
`C[letter after R]o[last letter of "moss"]s 
m[y="why" homophone] 
h[what suit has ♥]a[r sound spelled A-R-R]t, 
h[what you feel when expecting good things]o[past tense of "hop"]e 
t[word after "to ___ or not to ___"] 
d[Roman numeral for 500][vowel in "die"]`;

    const answers = {
      "letter after R": "S",
      "last letter of \"moss\"": "S",
      "y=\"why\" homophone": "Y",
      "what suit has ♥": "HEART",
      "r sound spelled A-R-R": "ARR",
      "what you feel when expecting good things": "HOPE",
      "past tense of \"hop\"": "HOPPED",
      "word after \"to ___ or not to ___\"": "BE",
      "Roman numeral for 500": "D",
      "vowel in \"die\"": "I"
    };

    const puzzleEl = document.getElementById("puzzleSentence");
    const clueEl = document.getElementById("currentClue");
    const answerInput = document.getElementById("answerInput");
    const statusEl = document.getElementById("status");
    const stepProgressEl = document.getElementById("stepProgress");
    const hintContainer = document.getElementById("hintContainer");
    const alreadyBanner = document.getElementById("alreadyBanner");

    let selectedBracket = null;

    function renderPuzzle() {
      puzzleEl.innerHTML = "";
      let idx = 0;
      let str = puzzleText;

      let bracketRegex = /\[([^\[\]]+)\]/g;
      let match;
      let lastIndex = 0;

      const parts = [];

      while ((match = bracketRegex.exec(str)) !== null) {
        const before = str.slice(lastIndex, match.index);
        if (before) parts.push(document.createTextNode(before));

        const clue = match[1];
        const isInnermost = !clue.includes("[") && !clue.includes("]");

        const span = document.createElement("span");
        span.className = "bracket" + (isInnermost ? " innermost" : "");
        span.textContent = "[" + clue + "]";
        span.dataset.clue = clue;

        if (isInnermost) {
          span.addEventListener("click", () => selectBracket(span));
        }

        parts.push(span);

        lastIndex = match.index + match[0].length;
      }

      if (lastIndex < str.length) {
        parts.push(document.createTextNode(str.slice(lastIndex)));
      }

      parts.forEach(p => puzzleEl.appendChild(p));
      updateProgress();
    }

    function selectBracket(el) {
      selectedBracket = el.dataset.clue;
      clueEl.textContent = "Current clue: " + selectedBracket;
      statusEl.textContent = "";
      answerInput.value = "";
      answerInput.focus();
    }

    function submitAnswer() {
      if (!selectedBracket) {
        statusEl.textContent = "Select an innermost bracket first.";
        statusEl.className = "error";
        return;
      }

      const input = answerInput.value.trim().toUpperCase();
      const expected = answers[selectedBracket].toUpperCase();

      if (input === expected) {
        statusEl.textContent = "Correct!";
        statusEl.className = "success";

        puzzleText = puzzleText.replace("[" + selectedBracket + "]", expected);
        selectedBracket = null;
        clueEl.textContent = "";

        checkCompletion();
        renderPuzzle();
      } else {
        statusEl.textContent = "Not quite. Try again.";
        statusEl.className = "error";
      }
    }

    function checkCompletion() {
      if (!puzzleText.includes("[")) {
        revealFinalSentence();
      }
    }

    function revealFinalSentence() {
      puzzleEl.innerHTML = "";
      FINAL_SENTENCE.split("").forEach(ch => {
        const span = document.createElement("span");
        span.textContent = ch;
        if (ch !== " ") {
          span.className = "letter";
          span.addEventListener("click", () => pickLetter(ch));
        }
        puzzleEl.appendChild(span);
      });

      stepProgressEl.textContent = "";
      hintContainer.style.display = "block";
    }

    function pickLetter(letter) {
      if (localStorage.getItem(DAY_KEY)) {
        openModal("letterModal");
        return;
      }

      if (letter === HIDDEN_LETTER) {
        localStorage.setItem(DAY_KEY, letter);
        alreadyBanner.style.display = "block";
        openModal("letterModal");
      } else {
        statusEl.textContent = "That's not the right letter.";
        statusEl.className = "error";
      }
    }

    function updateProgress() {
      const total = Object.keys(answers).length;
      const solved = total - (puzzleText.match(/\[/g) || []).length;
      stepProgressEl.textContent = `Solved ${solved} of ${total}`;
    }

    function openModal(id) {
      document.getElementById(id).classList.add("open");
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove("open");
    }

    document.getElementById("submitAnswer").onclick = submitAnswer;
    document.getElementById("backBtn").onclick = () => {
      window.location.href = "../../index.html";
    };
    document.getElementById("goHome").onclick = () => {
      window.location.href = "../../index.html";
    };
    document.querySelectorAll("[data-close]").forEach(btn =>
      btn.onclick = () => closeModal(btn.dataset.close)
    );

    document.addEventListener("keydown", e => {
      if (e.key === "Enter") submitAnswer();
      if (e.key === "Escape") closeModal("letterModal");
    });

    if (localStorage.getItem(DAY_KEY)) {
      alreadyBanner.style.display = "block";
    }

    renderPuzzle();
  </script>
</body>
</html>
