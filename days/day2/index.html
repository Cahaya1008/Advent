<!doctype html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Day 2 — Bracket City</title>
<style>
  body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#041226,#072238);color:#fff;padding:16px}
  .wrap{max-width:980px;margin:0 auto;background:rgba(255,255,255,0.02);padding:14px;border-radius:10px}
  h2{margin:0}
  .bracketArea{margin-top:12px;background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;line-height:1.4}
  .controls{margin-top:12px;display:flex;gap:8px;align-items:center}
  input{padding:8px;border-radius:8px;border:0}
  button{background:#ffd98a;border:0;padding:8px 10px;border-radius:8px;color:#072;font-weight:800}
  .muted{color:#b9cfe6}
  .found{margin-top:12px;background:#fff;color:#072;padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <h2>Day 2 — Bracket City</h2>
    <p class="muted">Solve the innermost bracket first. Type into the box and press Enter or Submit. Each solved bracket is replaced by your word.</p>

    <div class="bracketArea" id="bracketArea"></div>

    <div class="controls">
      <input id="entry" placeholder="Type word for innermost bracket"/>
      <button id="submit">Submit</button>
      <button id="closeBtn">Close</button>
    </div>

    <div id="hint" class="muted" style="margin-top:10px">Example prompt: "word before cube or Capades" → ICE</div>

    <div id="foundPanel" style="display:none" class="found"><div>Letter found: <strong id="foundLetter">O</strong></div><div><button id="closeFound">Close</button></div></div>
  </div>

<script>
/* Day 2 Bracket City */
const DAY = 2;
const COLLECT_LETTER = 'O';

// initial nested string from your brief (compressed to a manageable sample)
// Use the text provided in your spec — trimmed for readability in UI:
let source = `the Con[word after extension or [over[aggressively [[office with an extremely short commute] ➡️ ⬅️ amok] at battery], with "[a [speak criti[word after [[one might be of [etizer or lication preceder]proval] up] or curtain]y of or strike a door] one is a [horror movie actor's blood [write, but not by [[most filling course] (FR) or mano (MX)]]?]]]e makes its final flight`;

// We'll identify innermost brackets using regex
const area = document.getElementById('bracketArea');
const entry = document.getElementById('entry');
document.getElementById('submit').addEventListener('click', submit);
document.getElementById('closeBtn').addEventListener('click', closeSelf);
document.getElementById('closeFound').addEventListener('click', closeSelf);

function render(){
  area.innerHTML = highlightBrackets(source);
  updatePrompt();
}

function highlightBrackets(s){
  // simple HTML representation that highlights innermost bracket
  // find innermost bracket using regex
  const inn = /\[([^\[\]]*)\]/;
  let match = inn.exec(s);
  if(!match) return s.replace(/\n/g,'<br/>');
  const inner = match[1];
  // mark that portion with a span
  const before = s.slice(0,match.index);
  const after = s.slice(match.index + match[0].length);
  return before + `<mark style="background:rgba(255,217,130,0.12);padding:2px 6px;border-radius:4px">${inner}</mark>` + after;
}

function updatePrompt(){
  // find innermost bracket and show a friendly prompt
  const inn = /\[([^\[\]]*)\]/;
  const m = inn.exec(source);
  if(m){
    document.getElementById('hint').textContent = `Fill this bracket: ${m[1].slice(0,70)}... (innermost)`;
  } else {
    document.getElementById('hint').textContent = 'All brackets solved!';
    // puzzle complete
    collect();
  }
}

function submit(){
  const val = (entry.value||'').trim();
  if(!val){ alert('Type a word to fill the innermost bracket'); return; }
  // replace only the first innermost bracket
  source = source.replace(/\[([^\[\]]*)\]/, val);
  entry.value='';
  render();
}

function collect(){
  // already collected?
  if(window.collected) return;
  window.collected = true;
  // post message to parent
  try{
    if(window.parent && window.parent.collectLetterFromDay) window.parent.collectLetterFromDay(DAY, COLLECT_LETTER);
    else window.parent.postMessage({type:'collected', day:DAY, value:COLLECT_LETTER}, '*');
  }catch(e){
    window.parent.postMessage({type:'collected', day:DAY, value:COLLECT_LETTER}, '*');
  }
  document.getElementById('foundPanel').style.display = 'flex';
}

function closeSelf(){ try{ window.parent.hideModal(); }catch(e){ window.parent.postMessage({type:'requestClose'}, '*'); } }

render();
</script>
</body>
</html>
