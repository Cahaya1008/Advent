<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Advent Calendar ‚Äî Updated (Dec 1‚Äì11)</title>
<style>
  :root{
    --bg:#071022; --card:#eef6ff; --accent:#7aa7ff; --muted:#9fb3d6;
    --simon0:#ff6b6b; --simon1:#ffd93d; --simon2:#6bff9e; --simon3:#6bc3ff;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  body{background:linear-gradient(#071022,#081a32 60%); color:#e9f1ff; overflow-x:hidden;padding-bottom:60px;}
  header{padding:18px;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:1.2rem;letter-spacing:1px}
  .container{max-width:1100px;margin:0 auto;padding:12px;}
  .calendar{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-top:12px;}
  .day{
    background:linear-gradient(180deg,#10243f,#0b2940); border-radius:10px;padding:12px;min-height:120px;position:relative;
    display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    transition:transform .12s;
  }
  .day:hover{transform:translateY(-4px)}
  .day.locked{opacity:0.45;}
  .day h2{margin:0;font-size:1rem}
  .lock{position:absolute;right:10px;top:10px;font-size:20px;opacity:0.95}
  .foundBadge{position:absolute;left:10px;top:10px;background:#bff7d8;color:#052d13;padding:4px 8px;border-radius:8px;font-weight:800}
  #lettersFound{margin-top:16px;background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
  #lettersFound .letter{display:inline-block;background:#fff;color:#072;padding:8px 10px;margin:6px;border-radius:6px;font-weight:900}
  #secretCode{margin-top:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:10px}
  .controls{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#072;cursor:pointer;font-weight:700}
  .muted{color:var(--muted)}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(3,6,12,0.6);z-index:9999}
  .panel{background:#0f1628;color:#eaf3ff;padding:18px;border-radius:10px;max-width:1000px;width:96%;max-height:86vh;overflow:auto;position:relative}
  .closeBtn{position:absolute;right:12px;top:12px;font-size:20px;cursor:pointer}
  /* snow decorative */
  .snowflake{position:fixed;top:-10px;left:0;width:6px;height:6px;border-radius:50%;background:white;opacity:.9;pointer-events:none;animation:fall linear infinite}
  /* small game UI */
  .card{background:#fff;padding:12px;border-radius:10px;color:#09293b}
  .matching-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px} /* updated for 30 cards (6x5 grid) */
  .matching-card{height:90px;background:#f8fbff;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900;cursor:pointer;border:2px solid rgba(0,0,0,0.08);font-size:22px}
  .grid-sudoku-9{display:grid;grid-template-columns:repeat(9,44px);gap:2px;padding:6px;border-radius:8px;background:#cfe3ff}
  .grid-sudoku-9 input{width:44px;height:44px;text-align:center;border:1px solid #7ea7ff;border-radius:4px;font-weight:700;background:#fff;color:#102035;font-size:16px}
  .grid-sudoku-9 .block{border:2px solid #0b3b6f}
  .maze{display:inline-block;padding:8px;background:#fff;border-radius:8px}
  .maze .cell{width:16px;height:16px;display:inline-block;box-sizing:border-box;border:1px solid #ccc;vertical-align:top}
  .jigsawGrid{display:grid;grid-template-columns:repeat(3,140px);gap:6px;justify-content:center}
  .jigsawTile{width:140px;height:140px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:grab;border:2px solid rgba(0,0,0,0.06);font-weight:900;color:#fff;overflow:hidden}
  .spot-wrap{display:flex;gap:8px}
  .spot-box{width:320px;height:200px;background:#fff;border-radius:8px;position:relative;overflow:hidden;cursor:pointer;border:3px solid #e6eefc}
  footer{color:#9fb3d6;margin:18px;text-align:center}
  .hidden{display:none}
  .simonRow{display:flex;gap:12px}
  .simonBtn{width:84px;height:84px;border-radius:10px;border:3px solid rgba(0,0,0,0.08);cursor:pointer;font-weight:900;font-size:18px;color:#042}
  .simonFlash{box-shadow:0 0 18px rgba(255,255,255,0.6);transform:scale(1.05)}
</style>
</head>
<body>
<header>
  <div><h1>Advent Calendar ‚Äî Updated (Dec 1‚Äì11) Fourth Iteration</h1>
    <div class="muted" style="font-size:.9rem">Refinements: 30-card matching, real jigsaw drag-drop, 9√ó9 Sudoku, improved Simon, larger maze, better crossword.</div>
  </div>
  <div class="controls">
    <button id="resetBtn">Reset progress</button>
    <button id="viewLetters">View Letters</button>
  </div>
</header>

<div class="container">
  <div class="calendar" id="calendar"></div>

  <div id="lettersFound">
    <strong>Letters found</strong>
    <div id="lettersList"></div>
  </div>

  <div id="secretCode" style="margin-top:12px;">
    <strong>Secret code (locked until Dec 25)</strong>
    <div class="muted" id="codeArea">Final decoding will be available on or after Dec 25 once all letters are collected.</div>
  </div>
</div>

<!-- modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <div class="closeBtn" id="modalClose" title="Close">‚úï</div>
    <div id="modalContent"></div>
  </div>
</div>

<footer>
  Tips: use `?unlockAll=true` or `?test=decN` in the file URL to unlock while testing.
</footer>

<script>
/* ------------------------------
   State & helpers
   ------------------------------ */
const DAYS = 11;
const lettersPerDay = {1:'R',2:'T',3:'W',4:'V',5:'N',6:'P',7:'F',8:'D',9:'A',10:'U',11:'I'};
const dayNames = {
  1:'Wordle',2:'Mini-Crossword',3:'Matching (vs CPU)',4:'Jigsaw',5:'Riddle',
  6:'Maze',7:'Color Sequence',8:'Quote Fill',9:'Spot the Difference',10:'Sudoku (9√ó9)',11:'Minesweeper'
};
const storageKey = 'advent_updated_v1';
let state = JSON.parse(localStorage.getItem(storageKey) || '{}');
if(!state.found) state.found = {};
if(!state.sudokuHintsLeft && state.sudokuHintsLeft !== 0) state.sudokuHintsLeft = 3;
if(!state.sudokuRevealed) state.sudokuRevealed = {}; // key r-c -> value from hints

function saveState(){ localStorage.setItem(storageKey, JSON.stringify(state)); }

/* test override for unlocking */
function todayForUnlock(){
  try{
    const url = new URL(location.href);
    const t = url.searchParams.get('test');
    if(t && /^dec\d{1,2}$/i.test(t)) return new Date(2025,11,parseInt(t.slice(3)));
  }catch(e){}
  return new Date();
}

/* modal */
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
document.getElementById('modalClose').addEventListener('click', ()=>hideModal());
modal.addEventListener('click', (e)=>{ if(e.target===modal) hideModal(); });
function showModal(html){
  modalContent.innerHTML = html;
  modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false');
}
function hideModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); modalContent.innerHTML=''; saveState(); }

/* snow */
(function makeSnow(){ for(let i=0;i<18;i++){const s=document.createElement('div');s.className='snowflake';s.style.left=Math.random()*100+'%';s.style.width=(3+Math.random()*6)+'px';s.style.height=s.style.width;s.style.opacity=.5+Math.random()*.5;s.style.animationDuration=(4+Math.random()*7)+'s';document.body.appendChild(s);s.animate([{transform:'translateY(-10vh)'},{transform:`translateY(${120+Math.random()*60}vh)`}],{duration:4000+Math.random()*9000,iterations:Infinity,delay:Math.random()*-2000}); } })();

/* ------------------------------
   Calendar rendering + dispatcher
   ------------------------------ */
const cal = document.getElementById('calendar');
function buildCalendar(){
  cal.innerHTML='';
  const now = todayForUnlock();
  const month = now.getMonth(), date = now.getDate();
  for(let d=1; d<=DAYS; d++){
    const el = document.createElement('div'); el.className='day'; el.dataset.day=d;
    const title = document.createElement('h2'); title.textContent=`Day ${d}`;
    const sub = document.createElement('div'); sub.className='muted'; sub.textContent=dayNames[d]||'';
    el.appendChild(title); el.appendChild(sub);
    if(state.found[d]){
      const badge=document.createElement('div'); badge.className='foundBadge'; badge.textContent='FOUND'; el.appendChild(badge);
    } else {
      const lock=document.createElement('div'); lock.className='lock';
      const unlocked = (month===11 && date>=d) || location.search.includes('unlockAll=true') || location.search.includes('test=dec'+d);
      lock.textContent = unlocked ? 'üîì' : 'üîí';
      el.appendChild(lock);
      if(!unlocked) el.classList.add('locked');
    }
    el.addEventListener('click', ()=>openDay(d));
    cal.appendChild(el);
  }
  renderLetters();
}
buildCalendar();

function renderLetters(){
  const container = document.getElementById('lettersList'); container.innerHTML='';
  Object.keys(state.found||{}).sort((a,b)=>a-b).forEach(k=>{ const s=document.createElement('span'); s.className='letter'; s.textContent=lettersPerDay[k]; container.appendChild(s); });
}

/* dispatcher that calls day-specific functions */
function openDay(d){
  switch(d){
    case 1: return openDay1();
    case 2: return openDay2();
    case 3: return openDay3();
    case 4: return openDay4();
    case 5: return openDay5();
    case 6: return openDay6();
    case 7: return openDay7();
    case 8: return openDay8();
    case 9: return openDay9();
    case 10: return openDay10();
    case 11: return openDay11();
    default: alert('Day not implemented');
  }
}

/* store letter (modal is closeable) */
function storeLetter(day){
  if(state.found[day]) return;
  state.found[day]=true; saveState(); buildCalendar();
  showModal(`<div class="card"><h3>Nice ‚Äî Letter collected</h3><p>You collected the secret letter for Dec ${day}: <strong>${lettersPerDay[day]}</strong></p><div style="margin-top:12px"><button id="closeAfterCollect">Close</button></div></div>`);
  document.getElementById('closeAfterCollect').addEventListener('click', ()=>hideModal());
}

/* ------------------------------
   Day 1 ‚Äî Wordle THORN (unchanged behaviour)
   ------------------------------ */
function openDay1(){
  if(state.found[1]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[1]}</strong></p><div style="margin-top:12px"><button id="close1">Close</button></div></div>`); document.getElementById('close1').addEventListener('click', hideModal); return; }
  const html = `<div class="card"><h3>Dec 1 ‚Äî Wordle</h3><p>Guess the 5-letter word. No hint until solved. When you solve, click the correct letter in the solved word to store the secret letter.</p>
    <div id="wordRows" style="display:flex;flex-direction:column;gap:8px;margin-top:12px"></div>
    <div style="margin-top:8px"><input id="guess1" maxlength="5" placeholder="Type a 5-letter guess"/><button id="try1">Try</button></div>
    <div id="wordHintArea" class="muted" style="margin-top:12px;display:none"></div></div>`;
  showModal(html);
  const target='THORN';
  const rows=[];
  const rowContainer=document.getElementById('wordRows');
  function renderRows(){ rowContainer.innerHTML=''; rows.forEach(r=>{ const node=document.createElement('div'); node.style.display='flex'; node.style.gap='6px'; for(let i=0;i<5;i++){ const ch=document.createElement('div'); ch.style.width='46px'; ch.style.height='46px'; ch.style.display='inline-flex'; ch.style.alignItems='center'; ch.style.justifyContent='center'; ch.style.borderRadius='8px'; ch.style.fontWeight='900'; ch.style.background='#fff'; ch.style.color='#072'; const letter=r[i]||''; ch.textContent=letter; if(letter){ if(letter===target[i]) ch.style.background='#7cf'; else if(target.includes(letter)) ch.style.background='#ffd56b'; else ch.style.background='#e6e6e6'; } node.appendChild(ch);} rowContainer.appendChild(node); }); }
  renderRows();
  document.getElementById('try1').addEventListener('click', ()=>{
    const g=(document.getElementById('guess1').value||'').toUpperCase();
    if(g.length!==5){ alert('Enter 5 letters'); return; }
    rows.push(g); renderRows(); document.getElementById('guess1').value='';
    if(g===target){
      const hintArea=document.getElementById('wordHintArea'); hintArea.style.display='block';
      hintArea.innerHTML=`<strong>Hint revealed:</strong> <em>Heart - heat = ? (click the correct letter in the word above to store)</em>`;
      const lastRow=rowContainer.lastChild;
      for(let i=0;i<5;i++){
        const cell=lastRow.children[i];
        cell.style.cursor='pointer'; cell.title='Click to store letter';
        cell.addEventListener('click', ()=>{ const clickedLetter=target[i]; if(clickedLetter==='R'){ storeLetter(1); hideModal(); } else alert('That is not the secret letter ‚Äî try another letter.'); });
      }
    }
  });
}

/* ------------------------------
   Day 2 ‚Äî Mini-Crossword (refined)
   - 3x3 grid with sensible clues
   - center cell is highlighted and clickable only after solving -> reveals T
   ------------------------------ */
function openDay2(){
  if(state.found[2]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[2]}</strong></p><div style="margin-top:12px"><button id="close2">Close</button></div></div>`); document.getElementById('close2').addEventListener('click', hideModal); return; }
  // We'll use a consistent 3x3 with clear words. Center is T.
  // Grid:
  // L I P
  // A T E
  // R E D
  // Across clues:
  // 1. Part of the mouth that helps speak (3) -> LIP
  // 2. Past of eat (3) -> ATE
  // 3. A color (3) -> RED
  // Down clues:
  // 1. 3-letter word starting with L (3) -> LAR? We'll keep down clues simple to avoid over-complication; the interface enforces across correctness.
  const html = `<div class="card"><h3>Dec 2 ‚Äî Mini-Crossword</h3>
    <p>Solve the tiny crossword. The highlighted center cell is the secret letter ‚Äî it becomes clickable only after solving the puzzle.</p>
    <div style="margin-top:8px"><strong>Across</strong><ol><li>1. Part of the mouth that helps speak (3)</li><li>2. Past of eat (3)</li><li>3. A color (3)</li></ol></div>
    <div style="display:grid;grid-template-columns:repeat(3,56px);gap:4px;margin-top:10px">
      <input maxlength="1" id="c00"/><input maxlength="1" id="c01"/><input maxlength="1" id="c02"/>
      <input maxlength="1" id="c10"/><input maxlength="1" id="c11" style="background:#fff3c6;border:2px solid #f0d37a"/><input maxlength="1" id="c12"/>
      <input maxlength="1" id="c20"/><input maxlength="1" id="c21"/><input maxlength="1" id="c22"/>
    </div>
    <div style="margin-top:10px"><button id="check2">Check Crossword</button></div></div>`;
  showModal(html);
  const solution = { c00:'L', c01:'I', c02:'P', c10:'A', c11:'T', c12:'E', c20:'R', c21:'E', c22:'D' };
  document.getElementById('check2').addEventListener('click', ()=>{
    let ok=true;
    for(const id in solution){ const v=(document.getElementById(id).value||'').toUpperCase(); if(v!==solution[id]){ ok=false; break; } }
    if(ok){
      const c11=document.getElementById('c11'); c11.readOnly=true; c11.style.cursor='pointer';
      c11.addEventListener('click', ()=>{ storeLetter(2); hideModal(); });
      alert('Crossword solved! Click the highlighted center cell to collect the secret letter.');
    } else alert('Not solved yet ‚Äî keep trying!');
  });
}

/* ------------------------------
   Day 3 ‚Äî Matching (30 cards; CPU memory enhanced)
   - 6x5 grid, 15 pairs
   ------------------------------ */
function openDay3(){
  if(state.found[3]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[3]}</strong></p><div style="margin-top:12px"><button id="close3">Close</button></div></div>`); document.getElementById('close3').addEventListener('click', hideModal); return; }
  const html = `<div class="card"><h3>Dec 3 ‚Äî Matching (You vs CPU)</h3>
    <p>Play against a CPU that remembers seen cards. 30 cards total (15 pairs). Players alternate; if you find a pair you go again.</p>
    <div id="matchBoard" style="margin-top:12px" class="matching-grid"></div>
    <div style="margin-top:12px"><button id="restart3">Restart</button><span style="margin-left:12px" id="matchStatus" class="muted"></span></div></div>`;
  showModal(html);
  const board=document.getElementById('matchBoard'), status=document.getElementById('matchStatus');
  let cards=[], revealed=[], matched=[], cpuMemory={}, scores={player:0,cpu:0}, playerTurn=true, firstFlip=-1;
  function init(){
    const icons = ['üê∂','üê±','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','ü¶Ñ','üêù','üêô'];
    cards = icons.concat(icons).sort(()=>Math.random()-0.5);
    revealed = Array(cards.length).fill(false); matched = Array(cards.length).fill(false); cpuMemory={}; scores={player:0,cpu:0}; playerTurn=true; firstFlip=-1;
    render(); status.textContent='Your turn.';
  }
  function render(){ board.innerHTML=''; for(let i=0;i<cards.length;i++){ const c=document.createElement('div'); c.className='matching-card'; c.style.background = matched[i] ? '#e6f8ea' : '#fff'; c.textContent = (matched[i]||revealed[i]) ? cards[i] : ''; c.dataset.i=i; c.addEventListener('click', ()=>playerFlip(i)); board.appendChild(c); } }
  function playerFlip(i){
    if(!playerTurn) return; if(revealed[i]||matched[i]) return;
    revealIndex(i);
    if(firstFlip===-1){ firstFlip=i; return; }
    if(cards[firstFlip]===cards[i]){ matched[firstFlip]=matched[i]=true; scores.player++; status.textContent=`Nice! Score ‚Äî You: ${scores.player} CPU: ${scores.cpu}`; firstFlip=-1; render(); checkEnd(); }
    else { playerTurn=false; status.textContent='No match ‚Äî CPU turn.'; setTimeout(()=>{ revealed[firstFlip]=revealed[i]=false; firstFlip=-1; render(); cpuAction(); }, 700); }
  }
  function revealIndex(i){ revealed[i]=true; render(); }
  function cpuAction(){
    for(let v in cpuMemory) cpuMemory[v]=cpuMemory[v].filter(idx=>!matched[idx]);
    for(const v in cpuMemory){ if(cpuMemory[v].length>=2){ const [a,b]=cpuMemory[v]; revealIndex(a); setTimeout(()=>{ revealIndex(b); matched[a]=matched[b]=true; scores.cpu++; status.textContent=`CPU found a pair. Score ‚Äî You: ${scores.player} CPU: ${scores.cpu}`; render(); checkEnd(); setTimeout(()=>cpuAction(),500); },400); return; } }
    const pool=[]; for(let i=0;i<cards.length;i++) if(!revealed[i] && !matched[i]) pool.push(i);
    if(pool.length===0) return;
    const a=pool[Math.floor(Math.random()*pool.length)];
    revealIndex(a); cpuMemory[cards[a]] = Array.from(new Set([...(cpuMemory[cards[a]]||[]), a]));
    setTimeout(()=>{ const seen=(cpuMemory[cards[a]]||[]).find(ii=>ii!==a && !matched[ii]); let b; if(seen!==undefined) b=seen; else { const pool2=pool.filter(x=>x!==a); b = pool2.length ? pool2[Math.floor(Math.random()*pool2.length)] : null; } if(b===null){ playerTurn=true; status.textContent='Your turn.'; return; } revealIndex(b); cpuMemory[cards[b]] = Array.from(new Set([...(cpuMemory[cards[b]]||[]), b])); setTimeout(()=>{ if(cards[a]===cards[b]){ matched[a]=matched[b]=true; scores.cpu++; status.textContent=`CPU found a pair. Score ‚Äî You: ${scores.player} CPU: ${scores.cpu}`; render(); checkEnd(); setTimeout(()=>cpuAction(),500); } else { revealed[a]=revealed[b]=false; render(); playerTurn=true; status.textContent='Your turn.'; } },500); },600);
  }
  function checkEnd(){
    if(matched.every(Boolean)){ let msg=`Final score ‚Äî You: ${scores.player} CPU: ${scores.cpu}. `; if(scores.player>scores.cpu){ msg += 'You win! Collect your letter.'; status.textContent=msg; storeLetter(3); hideModal(); } else if(scores.player<scores.cpu){ msg += 'CPU wins. Try Restart.'; status.textContent=msg; } else { msg += "It's a tie. Restart to try again."; status.textContent=msg; } }
  }
  document.getElementById('restart3').addEventListener('click', ()=>init());
  init();
}

/* ------------------------------
   Day 4 ‚Äî Jigsaw: draggable tile puzzle (3x3)
   - Uses an image URL; tiles are created by CSS background-position; supports drag & drop swapping
   ------------------------------ */
function openDay4(){
  if(state.found[4]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[4]}</strong></p><div style="margin-top:12px"><button id="close4">Close</button></div></div>`); document.getElementById('close4').addEventListener('click', hideModal); return; }
  // Replace this image URL with your chosen puzzle image (ideally square)
  const imageURL = 'https://picsum.photos/seed/puzzle/600/600';
  const html = `<div class="card"><h3>Dec 4 ‚Äî Jigsaw (drag & drop)</h3>
    <p>Drag tiles to assemble the image. Once assembled, click Inspect to flip and reveal the letter on the back.</p>
    <div id="jigsaw" class="jigsawGrid" style="margin-top:12px"></div>
    <div style="margin-top:10px"><button id="shuffle4">Shuffle</button> <button id="inspect4" disabled>Inspect (flip)</button></div></div>`;
  showModal(html);
  const board=document.getElementById('jigsaw');
  // create tiles 3x3
  let tiles = Array.from({length:9}, (_,i)=>i+1);
  function tileBG(idx){
    const col = idx % 3, row = Math.floor(idx/3);
    const size = 300; // used for background-size calculation; CSS will scale but background-position relative works
    const bx = -(col/2)*100; // not precise with picsum; we instead compute background-position in percent
    const posX = (col) * (100/2); // percent mapping that works with background-size: 300%
    return {row, col};
  }
  function render(){
    board.innerHTML='';
    tiles.forEach((t,i)=>{
      const tile = document.createElement('div');
      tile.className='jigsawTile';
      // compute background position percentage
      const idx = t-1;
      const col = idx % 3, row = Math.floor(idx/3);
      tile.style.backgroundImage = `url(${imageURL})`;
      tile.style.backgroundSize = '300% 300%';
      tile.style.backgroundPosition = `${(col)*50}% ${(row)*50}%`;
      tile.draggable = true;
      tile.dataset.pos = i;
      tile.dataset.tile = t;
      tile.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', tile.dataset.pos); tile.style.opacity = '0.6'; });
      tile.addEventListener('dragend', ()=>{ tile.style.opacity='1'; });
      tile.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      tile.addEventListener('drop', (e)=>{ e.preventDefault(); const from = parseInt(e.dataTransfer.getData('text/plain')); const to = parseInt(tile.dataset.pos); const tmp=tiles[from]; tiles[from]=tiles[to]; tiles[to]=tmp; render(); checkSolved(); });
      board.appendChild(tile);
    });
  }
  function shuffle(){ tiles = tiles.sort(()=>Math.random()-0.5); render(); document.getElementById('inspect4').disabled = true; }
  function checkSolved(){ for(let i=0;i<9;i++) if(tiles[i] !== i+1) return; document.getElementById('inspect4').disabled = false; alert('Puzzle solved! Click Inspect to flip and reveal the letter.'); }
  document.getElementById('shuffle4').addEventListener('click', shuffle);
  document.getElementById('inspect4').addEventListener('click', ()=>{ showModal(`<div class="card"><h3>Back of puzzle</h3><p>The letter on the back is: <strong>V</strong></p><div style="margin-top:12px"><button id="close4b">Close</button></div></div>`); document.getElementById('close4b').addEventListener('click', ()=>{ storeLetter(4); hideModal(); }); });
  shuffle();
}

/* ------------------------------
   Day 5 ‚Äî Riddle (unchanged)
   ------------------------------ */
function openDay5(){
  if(state.found[5]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[5]}</strong></p><div style="margin-top:12px"><button id="close5">Close</button></div></div>`); document.getElementById('close5').addEventListener('click', hideModal); return; }
  const html=`<div class="card"><h3>Dec 5 ‚Äî Riddle</h3><p>‚ÄúBy vicious beast I'm guarded, By death on silver wings. Like gold, I last eternal, Treasure to queens and kings.‚Äù</p><div style="margin-top:8px"><input id="r5" placeholder="answer"/><button id="r5b">Submit</button></div></div>`;
  showModal(html);
  document.getElementById('r5b').addEventListener('click', ()=>{ const v=(document.getElementById('r5').value||'').trim().toLowerCase(); if(v==='honey'){ storeLetter(5); hideModal(); } else alert('Not quite ‚Äî try again.'); });
}

/* ------------------------------
   Day 6 ‚Äî Maze: much bigger, more complex (41x41)
   - DFS maze with wider corridors; arrow keys move avatar; goal reveals P
   ------------------------------ */
function openDay6(){
  if(state.found[6]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[6]}</strong></p><div style="margin-top:12px"><button id="close6">Close</button></div></div>`); document.getElementById('close6').addEventListener('click', hideModal); return; }
  const html = `<div class="card"><h3>Dec 6 ‚Äî Maze (big & nasty)</h3><p>Click inside the maze then use arrow keys. This maze is intentionally large and complex.</p><div id="mazeWrap" style="margin-top:12px;overflow:auto;max-height:60vh"></div><div style="margin-top:8px" class="muted">Click the maze area then use arrow keys.</div></div>`;
  showModal(html);
  const wrap=document.getElementById('mazeWrap');
  const rows=41, cols=41;
  const grid=Array(rows).fill(0).map(()=>Array(cols).fill(1));
  function carve(r,c){
    const dirs=[[ -2,0],[2,0],[0,-2],[0,2]].sort(()=>Math.random()-0.5);
    grid[r][c]=0;
    for(const [dr,dc] of dirs){
      const nr=r+dr, nc=c+dc;
      if(nr<=0||nr>=rows-1||nc<=0||nc>=cols-1) continue;
      if(grid[nr][nc]===1){ grid[r+dr/2][c+dc/2]=0; carve(nr,nc); }
    }
  }
  carve(1,1);
  let pr=1, pc=1, gr=rows-2, gc=cols-2;
  function render(){
    wrap.innerHTML='';
    const m=document.createElement('div'); m.className='maze';
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const cell=document.createElement('div'); cell.className='cell';
        if(r===pr && c===pc) cell.style.background='red';
        else if(r===gr && c===gc) cell.style.background='lightgreen';
        else cell.style.background = grid[r][c]===1 ? '#111' : '#fff';
        m.appendChild(cell);
      }
      const br=document.createElement('div'); br.style.clear='both'; m.appendChild(br);
    }
    wrap.appendChild(m);
    m.tabIndex=0; m.focus();
    m.onkeydown=(e)=>{ if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){ e.preventDefault(); const map={'ArrowUp':[-1,0],'ArrowDown':[1,0],'ArrowLeft':[0,-1],'ArrowRight':[0,1]}; const [dr,dc]=map[e.key]; movePlayer(dr,dc); } };
  }
  function movePlayer(dr,dc){
    const nr=pr+dr, nc=pc+dc; if(nr<0||nr>=rows||nc<0||nc>=cols) return; if(grid[nr][nc]===1) return; pr=nr; pc=nc; render();
    if(pr===gr && pc===gc){ showModal(`<div class="card"><h3>The box opens!</h3><p>You found the secret letter: <strong>P</strong></p><div style="margin-top:12px"><button id="close6b">Close</button></div></div>`); document.getElementById('close6b').addEventListener('click', ()=>{ storeLetter(6); hideModal(); }); }
  }
  render();
}
/* ------------------------------
   Day 7 ‚Äî Simon (colorful flashes)
   - Must pass 5 rounds to earn letter
   - Rounds: 3,4,5,6,7,8, then insane bonus
   ------------------------------ */
function openDay7(){
  if(state.found[7]) {
    showModal(`<div class="card"><h3>Already found</h3>
      <p>Letter: <strong>${lettersPerDay[7]}</strong></p>
      <div style="margin-top:12px"><button id="close7">Close</button></div></div>`
    );
    document.getElementById('close7').addEventListener('click', hideModal);
    return;
  }

  const html = `<div class="card">
    <h3>Dec 7 ‚Äî Color Sequence</h3>
    <p>Repeat the flashing pattern. Pass <strong>5 rounds</strong> to earn the secret letter.</p>
    <p class="muted">Bonus rounds are just for fun.</p>

    <div style="margin-top:12px" class="simonRow">
      <button id="s0" class="simonBtn" style="background:var(--simon0)">1</button>
      <button id="s1" class="simonBtn" style="background:var(--simon1)">2</button>
      <button id="s2" class="simonBtn" style="background:var(--simon2)">3</button>
      <button id="s3" class="simonBtn" style="background:var(--simon3)">4</button>
    </div>

    <div style="margin-top:12px">
      <button id="start7">Start</button>
      <span id="s7msg" class="muted" style="margin-left:12px"></span>
    </div>
  </div>`;

  showModal(html);

  const btns = [
    document.getElementById('s0'),
    document.getElementById('s1'),
    document.getElementById('s2'),
    document.getElementById('s3')
  ];
  const msg = document.getElementById('s7msg');

  function flash(i, fast=false){
    const b = btns[i];
    b.classList.add('simonFlash');
    setTimeout(()=>b.classList.remove('simonFlash'), fast ? 120 : 350);
  }

  async function playRoundAndGetInput(length, fast=false){
    const seq = [];
    for(let i=0; i<length; i++) seq.push(Math.floor(Math.random()*4));

    // play sequence
    for(const v of seq){
      flash(v, fast);
      await new Promise(res => setTimeout(res, fast ? 140 : 480));
    }

    // player repeats
    let index = 0;
    return new Promise(resolve => {
      function handler(e){
        const i = btns.indexOf(e.target);
        if(i === -1) return;

        flash(i, false);

        if(i !== seq[index]){
          btns.forEach(b=>b.removeEventListener('click', handler));
          resolve(false);
          return;
        }

        index++;
        if(index === seq.length){
          btns.forEach(b=>b.removeEventListener('click', handler));
          resolve(true);
        }
      }
      btns.forEach(b=>b.addEventListener('click', handler));
    });
  }

  document.getElementById('start7').addEventListener('click', async ()=>{
    msg.textContent = "Get ready...";

    let roundsPassed = 0;
    const rounds = [3,4,5,6,7,8];

    for(let i=0; i<rounds.length; i++){
      const length = rounds[i];
      msg.textContent = `Round ${i+1}: ${length} flashes`;

      const success = await playRoundAndGetInput(length, false);

      if(success){
        roundsPassed++;
        msg.textContent = `‚úî Passed round ${i+1}`;

        // You earn the letter ONLY after passing round 5 (index 0‚Äì4)
        if(roundsPassed === 5){
          alert("You've passed 5 rounds! Secret letter unlocked.");
          storeLetter(7);
        }

        await new Promise(res => setTimeout(res, 500));
      } else {
        msg.textContent = `Failed on round ${i+1}`;
        
        // If you hadn't passed 5 rounds yet ‚Üí no letter
        if(roundsPassed < 5){
          alert("You didn't pass enough rounds to earn the letter. Try again!");
        }

        return; // end here
      }
    }

    // Bonus round (insanely fast, intentionally impossible)
    msg.textContent = "Bonus Round: Impossible Mode...";
    await new Promise(res => setTimeout(res, 600));

    await playRoundAndGetInput(10, true);

    msg.textContent = "Bonus finished.";
  });
}


/* ------------------------------
   Day 8 ‚Äî Quote fill-in (unchanged)
   ------------------------------ */
function openDay8(){
  if(state.found[8]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[8]}</strong></p><div style="margin-top:12px"><button id="close8">Close</button></div></div>`); document.getElementById('close8').addEventListener('click', hideModal); return; }
  const html = `<div class="card"><h3>Dec 8 ‚Äî Quote fill-in</h3><p>Fill in: ‚ÄúI don't do ____, I don't talk about feelings‚Äù</p><div style="margin-top:8px"><input id="q8"/><button id="b8">Submit</button> <button id="hint8">Hint</button></div></div>`;
  showModal(html);
  document.getElementById('b8').addEventListener('click', ()=>{ const v=(document.getElementById('q8').value||'').trim().toLowerCase(); if(v==='ships'){ storeLetter(8); hideModal(); } else alert('Try again.'); });
  document.getElementById('hint8').addEventListener('click', ()=>alert("Hint: it's from Lego Batman!"));
}

/* ------------------------------
   Day 9 ‚Äî Spot the difference (unchanged placeholder + 4 stages)
   ------------------------------ */
function openDay9(){
  if(state.found[9]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[9]}</strong></p><div style="margin-top:12px"><button id="close9">Close</button></div></div>`); document.getElementById('close9').addEventListener('click', hideModal); return; }
  const pairs = [
    {left:'https://picsum.photos/seed/d1/640/420', right:'https://picsum.photos/seed/d1b/640/420', x:220,y:130,r:30},
    {left:'https://picsum.photos/seed/d2/640/420', right:'https://picsum.photos/seed/d2b/640/420', x:110,y:60,r:28},
    {left:'https://picsum.photos/seed/d3/640/420', right:'https://picsum.photos/seed/d3b/640/420', x:310,y:185,r:26},
    {left:'https://picsum.photos/seed/d4/640/420', right:'https://picsum.photos/seed/d4b/640/420', x:260,y:95,r:30}
  ];
  let stage=0;
  function renderStage(){
    const p = pairs[stage];
    showModal(`<div class="card"><h3>Spot the Difference ‚Äî Stage ${stage+1}/4</h3><p>Click the difference on the RIGHT image.</p><div class="spot-wrap" style="margin-top:10px"><div class="spot-box"><img src="${p.left}" style="width:100%;height:100%;object-fit:cover"/></div><div class="spot-box" id="spotR"><img src="${p.right}" style="width:100%;height:100%;object-fit:cover"/></div></div><div style="margin-top:8px" class="muted">Click the approximate spot. Replace images & coords in code for real differences.</div></div>`);
    const rightImg = document.getElementById('spotR');
    rightImg.addEventListener('click', (ev)=>{
      const rect = rightImg.getBoundingClientRect();
      const cx = ev.clientX - rect.left, cy = ev.clientY - rect.top;
      const scaleX = rect.width / 640, scaleY = rect.height / 420;
      const tx = p.x * scaleX, ty = p.y * scaleY, r = p.r * ((scaleX+scaleY)/2);
      const dist = Math.hypot(cx-tx, cy-ty);
      if(dist <= r){ stage++; if(stage >= pairs.length){ alert('All differences found! Letter A unlocked.'); storeLetter(9); hideModal(); } else { alert('Good! Next pair.'); renderStage(); } }
      else alert('Not the correct spot ‚Äî try another area.');
    }, {once:true});
  }
  renderStage();
}

/* ------------------------------
   Day 10 ‚Äî Sudoku (9x9) with persistent 3 hints
   - Proper 9x9 puzzle + solution embedded
   ------------------------------ */
function openDay10(){
  if(state.found[10]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[10]}</strong></p><div style="margin-top:12px"><button id="close10">Close</button></div></div>`); document.getElementById('close10').addEventListener('click', hideModal); return; }
  // A solvable 9x9 puzzle + solution (classic)
  const puzzle = [
    [5,3,0,0,7,0,0,0,0],
    [6,0,0,1,9,5,0,0,0],
    [0,9,8,0,0,0,0,6,0],
    [8,0,0,0,6,0,0,0,3],
    [4,0,0,8,0,3,0,0,1],
    [7,0,0,0,2,0,0,0,6],
    [0,6,0,0,0,0,2,8,0],
    [0,0,0,4,1,9,0,0,5],
    [0,0,0,0,8,0,0,7,9]
  ];
  const solution = [
    [5,3,4,6,7,8,9,1,2],
    [6,7,2,1,9,5,3,4,8],
    [1,9,8,3,4,2,5,6,7],
    [8,5,9,7,6,1,4,2,3],
    [4,2,6,8,5,3,7,9,1],
    [7,1,3,9,2,4,8,5,6],
    [9,6,1,5,3,7,2,8,4],
    [2,8,7,4,1,9,6,3,5],
    [3,4,5,2,8,6,1,7,9]
  ];
  const html = `<div class="card"><h3>Dec 10 ‚Äî Sudoku (9√ó9)</h3>
    <p>Classic 9√ó9 Sudoku. Use up to <strong>3 hints</strong> ‚Äî revealed numbers persist. Buttons: Reset (clears non-hint entries), Hint (reveals a correct number), Exit.</p>
    <div id="sudWrap" style="margin-top:12px"></div>
    <div style="margin-top:8px"><button id="sudReset">Reset</button> <button id="sudHint">Hint (<span id="hintLeft">${state.sudokuHintsLeft}</span>)</button> <button id="sudExit">Exit</button></div>
    <div id="sudokuMsg" style="margin-top:8px" class="muted"></div></div>`;
  showModal(html);
  const wrap=document.getElementById('sudWrap');
  function render(){
    wrap.innerHTML='';
    const grid=document.createElement('div'); grid.className='grid-sudoku-9';
    for(let r=0;r<9;r++){
      for(let c=0;c<9;c++){
        const inp=document.createElement('input'); inp.type='text'; inp.maxLength=1; inp.dataset.r=r; inp.dataset.c=c;
        const key=`${r}-${c}`;
        if(state.sudokuRevealed[key]){ inp.value = state.sudokuRevealed[key]; inp.disabled=true; inp.classList.add('block'); }
        else if(puzzle[r][c] && puzzle[r][c]!==0){ inp.value = puzzle[r][c]; inp.disabled=true; inp.classList.add('block'); }
        else inp.value = '';
        // add thick borders for boxes
        if(c%3===0) inp.style.borderLeft='3px solid #0b3b6f';
        if(r%3===0) inp.style.borderTop='3px solid #0b3b6f';
        if(c===8) inp.style.borderRight='3px solid #0b3b6f';
        if(r===8) inp.style.borderBottom='3px solid #0b3b6f';
        inp.addEventListener('input', ()=>{ inp.value = inp.value.replace(/[^1-9]/g,''); checkComplete(); });
        grid.appendChild(inp);
      }
    }
    wrap.appendChild(grid);
  }
  function checkComplete(){
    const inputs = wrap.querySelectorAll('input');
    for(const inp of inputs){
      if(inp.value.trim()==='') return false;
    }
    // verify against solution
    const inputsArr = Array.from(inputs);
    for(const inp of inputsArr){
      const r=parseInt(inp.dataset.r), c=parseInt(inp.dataset.c);
      if(parseInt(inp.value)!==solution[r][c]) return false;
    }
    alert('Sudoku solved! Letter U unlocked.'); storeLetter(10); hideModal(); return true;
  }
  document.getElementById('sudReset').addEventListener('click', ()=>{ // clear non-prefilled and non-hint
    Object.keys(state.sudokuRevealed || {}).forEach(k=>{}); render(); document.getElementById('sudokuMsg').textContent='Grid reset (hint reveals kept).';
  });
  document.getElementById('sudHint').addEventListener('click', ()=>{
    if(state.sudokuHintsLeft<=0){ alert('No hints left'); return; }
    // find first empty cell that's not prefilled or already revealed and fill with solution
    for(let r=0;r<9;r++){
      for(let c=0;c<9;c++){
        const key=`${r}-${c}`;
        if(puzzle[r][c] && puzzle[r][c]!==0) continue;
        if(state.sudokuRevealed[key]) continue;
        // reveal this cell
        state.sudokuRevealed[key] = solution[r][c];
        state.sudokuHintsLeft = Math.max(0, state.sudokuHintsLeft-1);
        document.getElementById('hintLeft').textContent = state.sudokuHintsLeft;
        saveState(); render(); return;
      }
    }
    alert('No empty cells available for hint.');
  });
  document.getElementById('sudExit').addEventListener('click', ()=>{ hideModal(); });
  render();
}

/* ------------------------------
   Day 11 ‚Äî Minesweeper (unchanged but first-click safe)
   ------------------------------ */
function openDay11(){
  if(state.found[11]) { showModal(`<div class="card"><h3>Already found</h3><p>Letter: <strong>${lettersPerDay[11]}</strong></p><div style="margin-top:12px"><button id="close11">Close</button></div></div>`); document.getElementById('close11').addEventListener('click', hideModal); return; }
  const html = `<div class="card"><h3>Dec 11 ‚Äî Minesweeper (25√ó25)</h3><p>25√ó25 grid with 100 bombs. First click safe.</p><div style="margin-top:8px"><button id="mineReset">Reset</button> <button id="mineHelp">?</button></div><div id="mineArea" style="margin-top:12px;overflow:auto;max-height:60vh"></div></div>`;
  showModal(html);
  const area=document.getElementById('mineArea');
  const rows=25, cols=25, bombsTotal=100;
  let grid=[], revealed=[], flagged=[], placed=false;
  function buildEmpty(){ grid=Array(rows).fill(0).map(()=>Array(cols).fill(0)); revealed=Array(rows).fill(0).map(()=>Array(cols).fill(false)); flagged=Array(rows).fill(0).map(()=>Array(cols).fill(false)); placed=false; }
  buildEmpty();
  function placeBombsAvoid(firstR, firstC){
    let placedCount=0; const forbidden=new Set();
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ const nr=firstR+dr, nc=firstC+dc; if(nr>=0&&nr<rows&&nc>=0&&nc<cols) forbidden.add(`${nr}-${nc}`); }
    while(placedCount < bombsTotal){
      const r=Math.floor(Math.random()*rows), c=Math.floor(Math.random()*cols), key=`${r}-${c}`;
      if(forbidden.has(key) || grid[r][c]===-1) continue;
      grid[r][c]=-1; placedCount++;
    }
    for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
      if(grid[r][c]===-1) continue; let cnt=0;
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ const nr=r+dr,nc=c+dc; if(nr<0||nr>=rows||nc<0||nc>=cols) continue; if(grid[nr][nc]===-1) cnt++; }
      grid[r][c]=cnt;
    }
    placed=true;
  }
  function render(){ area.innerHTML=''; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const btn=document.createElement('div'); btn.style.width='18px'; btn.style.height='18px'; btn.style.display='inline-flex'; btn.style.alignItems='center'; btn.style.justifyContent='center'; btn.style.border='1px solid #c6d6ee'; btn.style.background = revealed[r][c] ? '#fff' : '#e9f3ff'; btn.style.fontSize='11px'; btn.style.cursor='pointer'; if(flagged[r][c] && !revealed[r][c]) btn.textContent='üö©'; else if(revealed[r][c]){ if(grid[r][c]===-1) btn.textContent='üí£'; else if(grid[r][c]===0) btn.textContent=''; else btn.textContent = grid[r][c]; } btn.addEventListener('click', ()=>onReveal(r,c)); btn.addEventListener('contextmenu', (ev)=>{ ev.preventDefault(); toggleFlag(r,c); }); area.appendChild(btn); } const br=document.createElement('div'); br.style.clear='both'; area.appendChild(br); } }
  function revealCell(r,c){ if(r<0||r>=rows||c<0||c>=cols) return; if(revealed[r][c]||flagged[r][c]) return; revealed[r][c]=true; if(grid[r][c]===0){ for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){ if(dr===0 && dc===0) continue; revealCell(r+dr,c+dc); } } }
  function onReveal(r,c){ if(!placed){ placeBombsAvoid(r,c); } if(grid[r][c]===-1){ for(let i=0;i<rows;i++) for(let j=0;j<cols;j++) if(grid[i][j]===-1) revealed[i][j]=true; render(); alert('BOOM! You hit a bomb. Try Reset.'); buildEmpty(); return; } else { revealCell(r,c); render(); let won=true; for(let i=0;i<rows;i++) for(let j=0;j<cols;j++){ if(grid[i][j]!==-1 && !revealed[i][j]) { won=false; break; } } if(won){ alert('You cleared the minefield! Letter I collected.'); storeLetter(11); hideModal(); } } }
  function toggleFlag(r,c){ flagged[r][c]=!flagged[r][c]; render(); }
  document.getElementById('mineReset').addEventListener('click', ()=>{ buildEmpty(); render(); });
  document.getElementById('mineHelp').addEventListener('click', ()=>alert('Minesweeper rules:\n- Reveal all non-mine cells to win.\n- Numbers show how many mines are adjacent (8 neighbors).\n- Right-click (or long-press) to place flags.\n- First click is always safe (no bomb there).'));
  render();
}

/* ------------------------------
   Reset / View Letters
   ------------------------------ */
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(!confirm('Reset progress? This will clear which letters you have found.')) return;
  state = {found:{}, sudokuRevealed:{}, sudokuHintsLeft:3}; saveState(); buildCalendar(); alert('Progress reset.');
});
document.getElementById('viewLetters').addEventListener('click', ()=>{
  showModal(`<div class="card"><h3>Letters Found</h3><p>${Object.keys(state.found||{}).length ? Object.keys(state.found).sort((a,b)=>a-b).map(d=>`Day ${d}: ${lettersPerDay[d]}`).join('<br/>') : '<em>None yet</em>'}</p><div style="margin-top:12px"><button id="closeView">Close</button></div></div>`);
  document.getElementById('closeView').addEventListener('click', hideModal);
});

window.addEventListener('beforeunload', saveState);
</script>
</body>
</html>
