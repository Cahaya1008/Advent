<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Our Advent Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg: #020617;
      --card-frame: #f5f5f5;
      --card-main: #0f172a;     /* midnight blue */
      --card-main2: #111827;    /* darker bottom */
      --gold: #b68a2a;          /* soft gold accent */
      --locked: rgba(0, 0, 0, 0.45);
      --completed: #2f9f5b;
      --accent: #f9f0d9;
      --text-main: #fff;
      --text-dark: #333;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .page {
      position: relative;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
      z-index: 4;
    }

    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    header h1 {
      font-size: 2.4rem;
      letter-spacing: 0.06em;
      margin-bottom: 0.4rem;
    }

    header p {
      font-size: 0.95rem;
      opacity: 0.9;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr);
      gap: 2rem;
    }

    @media (min-width: 900px) {
      main {
        grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
        align-items: flex-start;
      }
    }

    /* Background layers */

    #starContainer {
      pointer-events: none;
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 1;
    }

    #snowContainer {
      pointer-events: none;
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 2;
    }

    #fireContainer {
      pointer-events: none;
      position: fixed;
      inset: auto 0 0 0;
      height: 40vh;
      overflow: visible;
      z-index: 3;
    }

    /* Snow */

    .snowflake {
      position: absolute;
      top: -10px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: white;
      opacity: 0.8;
      filter: blur(0.5px);
      animation-name: fall;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }

    @keyframes fall {
      to {
        transform: translate3d(0, 110vh, 0);
      }
    }

    /* Fire glow and embers */

    .fire-glow {
      position: absolute;
      bottom: -45%;
      left: 50%;
      transform: translateX(-50%);
      width: 80vw;
      max-width: 1100px;
      height: 130%;
      background:
        radial-gradient(circle at 50% 100%, rgba(252, 211, 77, 0.6), transparent 55%),
        radial-gradient(circle at 40% 100%, rgba(248, 113, 113, 0.55), transparent 60%),
        radial-gradient(circle at 60% 100%, rgba(251, 146, 60, 0.7), transparent 60%);
      opacity: 0.7;
      filter: blur(14px);
      animation: firePulse 3.2s ease-in-out infinite;
    }

    @keyframes firePulse {
      0% {
        opacity: 0.4;
        transform: translateX(-50%) scale(0.95);
      }
      50% {
        opacity: 0.95;
        transform: translateX(-50%) scale(1.06);
      }
      100% {
        opacity: 0.45;
        transform: translateX(-50%) scale(0.97);
      }
    }

    .ember {
      position: absolute;
      bottom: 0;
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(252, 211, 77, 0.95);
      box-shadow: 0 0 8px rgba(252, 211, 77, 0.9);
      opacity: 0.95;
      animation: emberRise 1.8s ease-out forwards;
    }

    @keyframes emberRise {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
        opacity: 1;
      }
      60% {
        transform: translate3d(0, -40vh, 0) scale(0.9);
        opacity: 0.7;
      }
      100% {
        transform: translate3d(0, -60vh, 0) scale(0.4);
        opacity: 0;
      }
    }

    /* Stars */

    .star {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.9);
      animation: twinkle 2.5s ease-in-out infinite alternate;
    }

    .star.secret-star {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255, 255, 255, 0.8);
      background: rgba(252, 211, 77, 0.95);
      box-shadow: 0 0 10px rgba(252, 211, 77, 0.9);
      border-radius: 999px;
      cursor: pointer;
      pointer-events: auto;
    }

    @keyframes twinkle {
      0% {
        opacity: 0.3;
        transform: scale(0.7);
      }
      100% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    /* Calendar */

    #calendarSection {
      z-index: 2;
      position: relative;
      margin-bottom: 1.5rem;
    }

    #calendarSection h2 {
      font-size: 1.15rem;
      margin-bottom: 0.6rem;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 0.75rem;
    }

    @media (max-width: 600px) {
      .calendar-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .day-tile {
      position: relative;
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      outline: none;
      border-radius: 14px;
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }

    .day-tile:focus-visible {
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.85);
    }

    .day-tile-inner {
      position: relative;
      background: var(--card-frame);
      border-radius: 14px;
      padding: 5px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
      overflow: hidden;
      height: 90px;           /* <-- fixed height for chunky cards */
    }

    @media (min-width: 900px) {
      .day-tile-inner {
        height: 110px;
      }
    }

    /* solid card */
    .present-top {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(to bottom, var(--card-main), var(--card-main2));
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* subtle inner border in gold */
    .present-top::before {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 8px;
      border: 1px solid rgba(182, 138, 42, 0.6);
      pointer-events: none;
    }

    .present-number {
      position: relative;
      font-weight: 700;
      font-size: 1.35rem;
      color: var(--accent);
      text-shadow: 0 0 6px rgba(0, 0, 0, 0.7);
    }

    /* hide old present parts */
    .present-body,
    .ribbon-vertical,
    .ribbon-horizontal,
    .bow {
      display: none !important;
    }

    .day-tile.locked .day-tile-inner::after,
    .day-tile.completed .day-tile-inner::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: var(--locked);
      display: block;
    }

    .day-tile.locked .lock-icon,
    .day-tile.completed .check-icon {
      position: absolute;
      inset: 0;
      margin: auto;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .lock-icon span,
    .check-icon span {
      font-size: 1.1rem;
      color: #fff;
    }

    .day-tile.completed .day-tile-inner::after {
      background: rgba(18, 95, 54, 0.7);
    }

    .day-tile.completed .check-icon {
      background: #2f9f5b;
    }

    .day-tile.available:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
      filter: brightness(1.03);
    }

    .calendar-note {
      margin-top: 0.6rem;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* Letters / secret code */

    #lettersSection {
      position: relative;
      z-index: 2;
      padding: 1rem 1.1rem;
      margin-top: 0.5rem;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(4px);
    }

    #lettersSection h2 {
      font-size: 1.15rem;
      margin-bottom: 0.35rem;
    }

    .letters-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    #lettersList {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      margin-bottom: 0.35rem;
      min-height: 1.5rem;
    }

    .letter-badge {
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      background: var(--accent);
      color: var(--text-dark);
      font-weight: 600;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    #lettersProgress {
      font-size: 0.85rem;
      margin-bottom: 0.7rem;
      opacity: 0.95;
    }

    .small-btn {
      border-radius: 999px;
      border: none;
      padding: 0.35rem 0.9rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      background: var(--accent);
      color: var(--text-dark);
      transition: transform 0.1s ease, box-shadow 0.1s ease,
        filter 0.1s ease;
    }

    .small-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
      filter: brightness(1.03);
    }

    .final-wrapper {
      margin-top: 0.5rem;
      padding-top: 0.6rem;
      border-top: 1px solid rgba(255, 255, 255, 0.18);
    }

    .final-wrapper h3 {
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .final-locked-text {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .final-message {
      margin-top: 0.4rem;
      padding: 0.7rem 0.8rem;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.28);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .final-message strong {
      display: block;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .hidden {
      display: none !important;
    }

    /* Reset */

    #resetSection {
      margin-top: 1.5rem;
      z-index: 2;
      position: relative;
    }

    #resetButton {
      border-radius: 999px;
      border: none;
      padding: 0.6rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: #f8f1e1;
      color: #6b3c3c;
      transition: transform 0.1s.ease, box-shadow 0.12s ease,
        filter 0.1s ease;
    }

    #resetButton:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      filter: brightness(1.02);
    }

    .reset-note {
      font-size: 0.8rem;
      margin-top: 0.4rem;
      opacity: 0.85;
    }

    /* Modals */

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 20;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      max-width: 420px;
      width: 100%;
      padding: 1.2rem 1.25rem 1.1rem;
      background: #faf5f0;
      border-radius: 18px;
      color: var(--text-dark);
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .modal h2 {
      font-size: 1.05rem;
      margin-bottom: 0.4rem;
    }

    .modal p {
      font-size: 0.9rem;
      line-height: 1.45;
    }

    .modal-close {
      position: absolute;
      right: 0.7rem;
      top: 0.6rem;
      border: none;
      background: transparent;
      font-size: 1.2rem;
      cursor: pointer;
      color: #555;
    }

    .modal-footer {
      margin-top: 0.9rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
      background: #e7ded3;
      color: #333;
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.95rem;
      font-size: 0.8rem;
      cursor: pointer;
      background: #2f855a;
      color: white;
    }

    /* Star lock form */

    .code-form {
      margin-top: 0.6rem;
    }

    .code-form label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.25rem;
    }

    .code-input {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 9px;
      border: 1px solid #d0c5b8;
      font-size: 0.9rem;
    }

    .code-input:focus-visible {
      outline: 2px solid #2f855a;
      outline-offset: 1px;
    }

    .code-message {
      font-size: 0.8rem;
      margin-top: 0.25rem;
      min-height: 16px;
    }
  </style>
</head>
<body>
  <div id="starContainer"></div>
  <div id="snowContainer"></div>
  <div id="fireContainer"></div>

  <div class="page">
    <header>
      <h1>Our Advent Calendar</h1>
      <p>
        One tiny puzzle each day. Collect the hidden letters and unlock the
        final message on Christmas. üéÑ
      </p>
    </header>

    <main>
      <section>
        <section id="calendarSection">
          <h2>December Presents</h2>
          <div class="calendar-grid" id="calendarGrid"></div>
          <p class="calendar-note" id="calendarNote"></p>
        </section>
      </section>

      <section>
        <section id="lettersSection">
          <div class="letters-toolbar">
            <h2>Letters Found</h2>
            <button class="small-btn" id="openLettersModal">
              View all letters
            </button>
          </div>
          <div id="lettersList"></div>
          <p id="lettersProgress"></p>

          <div class="final-wrapper">
            <h3>Secret final message</h3>
            <p class="final-locked-text" id="finalLockedText">
              Collect all the special letters and unlock the star code.
              On Christmas Day, the hidden sentence will reveal itself.
            </p>
            <div id="finalMessage" class="final-message hidden">
              <strong>Final message:</strong>
              LOVE KNOWS NOT ITS DEPTH TILL THE HOUR OF SEPARATION
            </div>
          </div>
        </section>

        <section id="resetSection">
          <button id="resetButton">Reset progress</button>
          <p class="reset-note">
            This resets everything on this device (calendar, stars, letters,
            and final message). Use if you want to replay or if something breaks.
          </p>
        </section>
      </section>
    </main>
  </div>

  <!-- Modals -->

  <!-- Letters modal -->
  <div class="modal" id="lettersModal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" data-close="lettersModal">&times;</button>
      <h2>Your letter collection</h2>
      <p style="margin-bottom: 0.6rem;">
        These are the unique letters you‚Äôve uncovered so far. Each day (and the
        secret star) will add at most one new letter.
      </p>
      <div id="lettersModalList" style="margin-bottom:0.6rem;"></div>
      <p id="lettersModalProgress"></p>
      <div class="modal-footer">
        <button class="btn-primary" data-close="lettersModal">Back to calendar</button>
      </div>
    </div>
  </div>

  <!-- Locked day modal -->
  <div class="modal" id="lockedDayModal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" data-close="lockedDayModal">&times;</button>
      <h2>Too early!</h2>
      <p id="lockedDayText"></p>
      <div class="modal-footer">
        <button class="btn-primary" data-close="lockedDayModal">
          Got it
        </button>
      </div>
    </div>
  </div>

  <!-- Already found modal -->
  <div class="modal" id="alreadyFoundModal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" data-close="alreadyFoundModal">&times;</button>
      <h2>Letter already collected ‚úâÔ∏è</h2>
      <p>
        You‚Äôve already grabbed the secret from that day. Check your ‚ÄúLetters
        Found‚Äù section below ‚Äî it‚Äôs safely stored there.
      </p>
      <div class="modal-footer">
        <button class="btn-secondary" data-close="alreadyFoundModal">
          Close
        </button>
        <button class="btn-primary" data-open="lettersModal">
          View letters
        </button>
      </div>
    </div>
  </div>

  <!-- Star / code modal -->
  <div class="modal" id="starModal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" data-close="starModal">&times;</button>
      <h2>The secret star lock</h2>
      <p>
        Somewhere in the daily puzzles you‚Äôll discover a 7-digit code.
        When you think you know it, enter it here. If you‚Äôre right, you‚Äôll
        earn a very special letter.
      </p>
      <form class="code-form" id="codeForm">
        <label for="codeInput">Enter the 7-digit code</label>
        <input
          id="codeInput"
          class="code-input"
          inputmode="numeric"
          autocomplete="off"
          maxlength="7"
          minlength="7"
          placeholder="XXXXXXX"
        />
        <div class="code-message" id="codeMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" data-close="starModal">
            Cancel
          </button>
          <button type="submit" class="btn-primary">Unlock</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Star already solved modal -->
  <div class="modal" id="starSolvedModal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" data-close="starSolvedModal">&times;</button>
      <h2>The stars remember ‚≠ê</h2>
      <p>
        You‚Äôve already solved the secret star lock and claimed its letter.
        The stars are just here to sparkle now.
      </p>
      <div class="modal-footer">
        <button class="btn-primary" data-close="starSolvedModal">
          Back to calendar
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const TOTAL_DAYS = 24;

    const UNIQUE_LETTERS = [
      "L",
      "O",
      "V",
      "E",
      "K",
      "N",
      "W",
      "S",
      "T",
      "I",
      "D",
      "P",
      "H",
      "U",
      "R",
      "F",
      "A"
    ];

    const STAR_LETTER = "O";
    const STAR_CODE = "5201314";

    const IGNORE_DATE_LOCKS = false;

    // Simulated date from ?test=decNN query
    let SIMULATED_DATE = null;
    (function initSimulatedDateFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const test = params.get("test");
      if (!test) return;
      const match = /^dec(\d{1,2})$/i.exec(test.trim());
      if (!match) return;
      const dayNum = parseInt(match[1], 10);
      if (Number.isNaN(dayNum) || dayNum < 1 || dayNum > 31) return;
      const realNow = new Date();
      SIMULATED_DATE = new Date(realNow.getFullYear(), 11, dayNum);
    })();

    // ===== UTILS =====

    function getToday() {
      if (SIMULATED_DATE && !IGNORE_DATE_LOCKS) {
        return new Date(SIMULATED_DATE.getTime());
      }
      return new Date();
    }

    function isChristmasOrLater() {
      const now = getToday();
      const christmas = new Date(now.getFullYear(), 11, 25);
      return now >= christmas;
    }

    function isDayUnlocked(dayNumber) {
      if (IGNORE_DATE_LOCKS) return true;
      const now = getToday();
      const decDay = new Date(now.getFullYear(), 11, dayNumber);
      return now >= decDay;
    }

    function openModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
    }

    function getCollectedLetters() {
      const stored = localStorage.getItem("advent_letters");
      let letters = [];

      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          if (Array.isArray(parsed)) {
            letters = parsed;
          }
        } catch (e) {
          // ignore
        }
      }

      const set = new Set(letters.map((c) => String(c).toUpperCase()));

      for (let day = 1; day <= TOTAL_DAYS; day++) {
        const key = "advent_day_" + day + "_letter";
        const letter = localStorage.getItem(key);
        if (letter) set.add(letter.toUpperCase());
      }

      const starLetter = localStorage.getItem("advent_star_letter");
      if (starLetter) set.add(starLetter.toUpperCase());

      const finalArr = Array.from(set);
      localStorage.setItem("advent_letters", JSON.stringify(finalArr));
      return finalArr;
    }

    function renderLetterBadges(container, letters) {
      container.innerHTML = "";
      if (!letters.length) {
        const p = document.createElement("p");
        p.textContent = "No letters yet. Open a present to find your first one!";
        p.style.fontSize = "0.85rem";
        p.style.opacity = "0.9";
        container.appendChild(p);
        return;
      }
      letters
        .sort()
        .forEach((letter) => {
          const span = document.createElement("span");
          span.className = "letter-badge";
          span.textContent = letter;
          container.appendChild(span);
        });
    }

    function updateLettersUI() {
      const letters = getCollectedLetters();
      const list = document.getElementById("lettersList");
      const progress = document.getElementById("lettersProgress");
      const modalList = document.getElementById("lettersModalList");
      const modalProgress = document.getElementById("lettersModalProgress");

      const haveCount = UNIQUE_LETTERS.filter((L) =>
        letters.includes(L)
      ).length;
      const totalCount = UNIQUE_LETTERS.length;

      renderLetterBadges(list, letters);
      renderLetterBadges(modalList, letters);

      const msgBase = `You have discovered ${haveCount} / ${totalCount} special letters.`;
      const extra =
        haveCount === totalCount
          ? " All the letters for the final sentence are now in your collection!"
          : "";
      progress.textContent = msgBase + extra;
      modalProgress.textContent = msgBase + extra;

      checkFinalUnlockConditions();
    }

    function checkFinalUnlockConditions() {
      const letters = getCollectedLetters();
      const haveAll = UNIQUE_LETTERS.every((L) => letters.includes(L));
      const starSolved = localStorage.getItem("advent_star_solved") === "true";
      const finalUnlockedStored =
        localStorage.getItem("advent_final_unlocked") === "true";

      const finalMessage = document.getElementById("finalMessage");
      const lockedText = document.getElementById("finalLockedText");

      if (finalUnlockedStored || (haveAll && starSolved && isChristmasOrLater())) {
        finalMessage.classList.remove("hidden");
        lockedText.textContent =
          "You did it! You‚Äôve collected all the letters and solved the star lock. Here is the final message:";
        localStorage.setItem("advent_final_unlocked", "true");
      } else {
        finalMessage.classList.add("hidden");
        lockedText.textContent =
          "Collect all the special letters and unlock the star code. On Christmas Day, the hidden sentence will reveal itself.";
      }
    }

    // ===== Calendar =====

    function buildCalendar() {
      const grid = document.getElementById("calendarGrid");
      grid.innerHTML = "";

      for (let day = 1; day <= TOTAL_DAYS; day++) {
        const tileBtn = document.createElement("button");
        tileBtn.className = "day-tile";
        tileBtn.setAttribute("type", "button");
        tileBtn.dataset.day = String(day);

        const inner = document.createElement("div");
        inner.className = "day-tile-inner";

        const top = document.createElement("div");
        top.className = "present-top";

        const number = document.createElement("div");
        number.className = "present-number";
        number.textContent = day;
        top.appendChild(number);

        const body = document.createElement("div");
        body.className = "present-body";

        const ribbonV = document.createElement("div");
        ribbonV.className = "ribbon-vertical";
        const ribbonH = document.createElement("div");
        ribbonH.className = "ribbon-horizontal";
        const bow = document.createElement("div");
        bow.className = "bow";

        body.appendChild(ribbonV);
        body.appendChild(ribbonH);
        body.appendChild(bow);

        inner.appendChild(top);
        inner.appendChild(body);

        tileBtn.appendChild(inner);

        const hasLetter =
          localStorage.getItem("advent_day_" + day + "_letter") !== null;
        const unlocked = isDayUnlocked(day);

        let state = "locked";
        if (hasLetter) state = "completed";
        else if (unlocked) state = "available";

        tileBtn.dataset.state = state;
        tileBtn.classList.add(state);

        if (state === "locked") {
          const lock = document.createElement("div");
          lock.className = "lock-icon";
          lock.innerHTML = "<span>üîí</span>";
          tileBtn.appendChild(lock);
        } else if (state === "completed") {
          const check = document.createElement("div");
          check.className = "check-icon";
          check.innerHTML = "<span>‚úì</span>";
          tileBtn.appendChild(check);
        }

        tileBtn.addEventListener("click", () =>
          onDayTileClick(day, tileBtn)
        );

        grid.appendChild(tileBtn);
      }

      const note = document.getElementById("calendarNote");
      if (IGNORE_DATE_LOCKS) {
        note.textContent =
          "Test mode: date locks are disabled. All presents are available.";
      } else {
        const today = getToday();
        const baseText = today.toLocaleDateString(undefined, {
          month: "long",
          day: "numeric",
        });

        if (SIMULATED_DATE) {
          note.textContent =
            `Test mode: pretending today is ${baseText}. Presents unlock on their matching December date.`;
        } else {
          note.textContent =
            `Today is ${baseText}. Presents unlock on their matching December date.`;
        }
      }
    }

    function onDayTileClick(day, tileEl) {
      const state = tileEl.dataset.state;

      if (state === "locked") {
        const text = document.getElementById("lockedDayText");
        text.textContent = `That present unlocks on December ${day}. Come back then!`;
        openModal("lockedDayModal");
        return;
      }

      if (state === "completed") {
        openModal("alreadyFoundModal");
        return;
      }

      window.location.href = `days/day${day}/index.html`;
    }

    // ===== Stars / code =====

    function initStars() {
      const container = document.getElementById("starContainer");
      if (!container) return;

      const count = 60;
      for (let i = 0; i < count; i++) {
        const star = document.createElement("div");
        star.className = "star";
        const size = 2 + Math.random() * 3;
        star.style.width = size + "px";
        star.style.height = size + "px";
        star.style.left = Math.random() * 100 + "vw";
        star.style.top = Math.random() * 100 + "vh";
        star.style.animationDuration = 2.5 + Math.random() * 2 + "s";
        star.style.animationDelay = Math.random() * 3 + "s";
        container.appendChild(star);
      }

      const secret = document.createElement("button");
      secret.id = "secretStar";
      secret.className = "star secret-star";
      secret.type = "button";
      secret.setAttribute("aria-label", "Secret star");
      secret.style.top = "18%";
      secret.style.right = "12%";
      secret.style.animationDuration = "3s";
      secret.style.animationDelay = "0.4s";
      container.appendChild(secret);

      const starSolved =
        localStorage.getItem("advent_star_solved") === "true";

      if (starSolved) {
        secret.addEventListener("click", () => openModal("starSolvedModal"));
      } else {
        secret.addEventListener("click", () => openModal("starModal"));
      }

      const codeForm = document.getElementById("codeForm");
      const codeInput = document.getElementById("codeInput");
      const codeMsg = document.getElementById("codeMessage");

      codeForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const raw = (codeInput.value || "").trim();
        if (raw.length !== 7) {
          codeMsg.textContent = "The code should be exactly 7 digits.";
          return;
        }
        if (raw === STAR_CODE) {
          localStorage.setItem("advent_star_solved", "true");
          localStorage.setItem("advent_star_letter", STAR_LETTER);
          codeMsg.textContent =
            "Unlocked! A secret letter has been added to your collection.";
          codeMsg.style.color = "#2f855a";
          secret.onclick = () => openModal("starSolvedModal");
          updateLettersUI();
          setTimeout(() => {
            closeModal("starModal");
            openModal("lettersModal");
          }, 900);
        } else {
          codeMsg.textContent = "Not quite. Keep collecting clues from the days!";
          codeMsg.style.color = "#b83232";
        }
      });
    }

    // ===== Snow =====

    function initSnow() {
      const container = document.getElementById("snowContainer");
      const flakeCount = 70;
      for (let i = 0; i < flakeCount; i++) {
        const flake = document.createElement("div");
        flake.className = "snowflake";
        const size = 2 + Math.random() * 4;
        flake.style.width = size + "px";
        flake.style.height = size + "px";
        flake.style.left = Math.random() * 100 + "vw";
        flake.style.animationDuration = 8 + Math.random() * 8 + "s";
        flake.style.animationDelay = Math.random() * 8 + "s";
        container.appendChild(flake);
      }
    }

    // ===== Fire & embers =====

    function initFire() {
      const container = document.getElementById("fireContainer");
      if (!container) return;

      const glow = document.createElement("div");
      glow.className = "fire-glow";
      container.appendChild(glow);

      function spawnEmber() {
        const ember = document.createElement("div");
        ember.className = "ember";

        const spread = 0.35;
        const rand = (Math.random() - 0.5) * 2 * spread;
        const offsetPercent = 50 + rand * 100;

        ember.style.left = offsetPercent + "%";

        const size = 3 + Math.random() * 4;
        ember.style.width = size + "px";
        ember.style.height = size + "px";

        const duration = 1.5 + Math.random() * 1.4;
        ember.style.animationDuration = duration + "s";

        container.appendChild(ember);

        ember.addEventListener("animationend", () => {
          ember.remove();
        });
      }

      setInterval(() => {
        if (Math.random() < 0.45) {
          const count = Math.random() < 0.25 ? 2 : 1;
          for (let i = 0; i < count; i++) {
            setTimeout(spawnEmber, i * 180);
          }
        }
      }, 550);
    }

    // ===== Reset =====

    function initReset() {
      const btn = document.getElementById("resetButton");
      btn.addEventListener("click", () => {
        const ok = confirm(
          "Reset all progress? (Days, letters, stars, and final message will all be cleared.)"
        );
        if (!ok) return;

        for (let day = 1; day <= TOTAL_DAYS; day++) {
          localStorage.removeItem("advent_day_" + day + "_letter");
        }

        localStorage.removeItem("advent_letters");
        localStorage.removeItem("advent_star_letter");
        localStorage.removeItem("advent_star_solved");
        localStorage.removeItem("advent_final_unlocked");

        location.reload();
      });
    }

    // ===== Modals generic close handlers =====

    function initModals() {
      document.querySelectorAll("[data-close]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-close");
          if (id) closeModal(id);
        });
      });

      document.querySelectorAll("[data-open]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-open");
          if (id) openModal(id);
        });
      });

      document.querySelectorAll(".modal").forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.classList.remove("open");
            modal.setAttribute("aria-hidden", "true");
          }
        });
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          document
            .querySelectorAll(".modal.open")
            .forEach((m) => m.classList.remove("open"));
        }
      });

      const openLettersButton = document.getElementById("openLettersModal");
      openLettersButton.addEventListener("click", () =>
        openModal("lettersModal")
      );
    }

    // ===== Boot =====

    document.addEventListener("DOMContentLoaded", () => {
      initStars();
      initSnow();
      initFire();
      buildCalendar();
      initModals();
      initReset();
      updateLettersUI();
    });

    // NOTE: On each day page, award a letter with:
    // localStorage.setItem("advent_day_X_letter", "L");
  </script>
</body>
</html>
